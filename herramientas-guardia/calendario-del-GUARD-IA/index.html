<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Turnos Multi-Calendario</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Variables de Color (Simplificadas y Optimizadas) --- */
        :root {
            /* Modo Oscuro (Default) */
            --bg-color: #121212;
            --card-color: #1e1e1e;
            --text-color: #e0e0e0;
            --text-medium-color: #a0a0a0;
            --accent-color: #39FF14; /* Verde Neón */
            --accent-text-color: #0a0a0a;
            --border-color: rgba(255, 255, 255, 0.15);
            --cell-border-color: rgba(255, 255, 255, 0.1);
            --button-hover-bg: rgba(255, 255, 255, 0.08);
            --cancel-button-bg: #b91c1c;
            --cancel-button-text: #ffffff;
            --week-number-color: var(--text-medium-color);

            /* Colores de Turnos (Oscuro) */
            --shift-m-bg: #2563eb;
            --shift-t-bg: #d97706;
            --shift-n-bg: #7c3aed;
            --shift-l-bg: #059669;
            --shift-text-light: #ffffff;
            --shift-text-dark: #ffffff;
            --note-text-color: var(--text-medium-color);
        }

        body.light-mode {
            /* Modo Claro */
            --bg-color: #f8f9fa;
            --card-color: #ffffff;
            --text-color: #212529;
            --text-medium-color: #6c757d;
            --accent-color: #007bff; /* Azul */
            --accent-text-color: #ffffff;
            --border-color: rgba(0, 0, 0, 0.1);
            --cell-border-color: rgba(0, 0, 0, 0.15);
            --button-hover-bg: rgba(0, 0, 0, 0.05);
            --cancel-button-bg: #dc3545;
            --cancel-button-text: #ffffff;
            --week-number-color: var(--text-medium-color);

            /* Colores Turnos (Claro) */
            --shift-m-bg: #60a5fa;
            --shift-t-bg: #fbbf24;
            --shift-n-bg: #a78bfa;
            --shift-l-bg: #34d399;
            --shift-text-light: #ffffff;
            --shift-text-dark: #1f2937;
            --note-text-color: var(--text-medium-color);
        }

        /* --- Estilos Base & Tipografía --- */
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .hidden { display: none; }

        /* --- Contenedor Principal y Cabecera --- */
        .main-container { max-width: 56rem; margin: 0 auto; padding: 1rem; }
        @media (min-width: 640px) { .main-container { padding: 1.5rem; } }
        @media (min-width: 1024px) { .main-container { padding: 2rem; max-width: 64rem; } }

        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
        .header-button {
            background-color: var(--card-color);
            color: var(--text-color);
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 9999px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            text-decoration: none;
        }
        .header-button:hover { background-color: var(--button-hover-bg); }
        .header-actions-right { display: flex; gap: 0.5rem; }

        .back-link-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-color);
            text-decoration: none;
            transition: color 0.2s;
        }
        .back-link-header:hover { color: var(--accent-color); }
        .back-link-header i { font-size: 1.25rem; }
        .back-link-header h2 { font-size: 1.125rem; font-weight: 600; margin: 0; }

        #auth-state {
            background-color: var(--card-color);
            padding: 1rem;
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            text-align: center;
            margin-bottom: 1.5rem;
        }
        #auth-state a {
            color: var(--accent-color);
            font-weight: bold;
            text-decoration: underline;
        }

        .main-title { font-size: 1.5rem; font-weight: 700; text-align: center; margin-bottom: 1.5rem; color: var(--text-color); }
        @media (min-width: 640px) { .main-title { font-size: 1.875rem; } }

        #calendarManagement {
            background-color: var(--card-color);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
            justify-content: center;
            max-width: 48rem;
            margin-left: auto;
            margin-right: auto;
            border: 1px solid var(--border-color);
        }
        #calendarManagement label { font-size: 0.875rem; font-weight: 500; color: var(--text-color); margin-right: 0.25rem; }
        #calendarSelector, #newCalendarName {
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            padding: 0.4rem 0.6rem;
            font-size: 0.875rem;
            flex-grow: 1;
            min-width: 120px;
            max-width: 200px;
        }
        .management-button {
            padding: 0.45rem 0.8rem;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease, opacity 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        .management-button:disabled { opacity: 0.5; cursor: not-allowed; }
        #addCalendarBtn { background-color: var(--accent-color); color: var(--accent-text-color); }
        #addCalendarBtn:hover:not(:disabled) { filter: brightness(1.1); }
        #deleteCalendarBtn { background-color: var(--cancel-button-bg); color: var(--cancel-button-text); }
        #deleteCalendarBtn:hover:not(:disabled) { filter: brightness(0.9); }

        .calendar-container {
            background-color: var(--card-color);
            color: var(--text-color);
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1rem;
            border: 1px solid var(--border-color);
        }
        @media (min-width: 640px) { .calendar-container { padding: 1.5rem; } }

        .calendar-grid-header {
            display: grid;
            grid-template-columns: repeat(8, minmax(0, 1fr));
            text-align: center;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-medium-color);
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        .calendar-grid { display: grid; grid-template-columns: repeat(8, minmax(0, 1fr)); }
        .calendar-grid .day-cell {
            min-height: 6rem;
            padding: 0.25rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            position: relative;
            transition: background-color 0.2s ease;
            border-right: 1px solid var(--cell-border-color);
            border-bottom: 1px solid var(--cell-border-color);
            cursor: pointer;
            overflow: hidden;
        }
        .week-number-cell {
            color: var(--week-number-color);
            font-size: 0.75rem;
            font-weight: 500;
            cursor: default;
            align-items: center;
            justify-content: center;
            border-right: 1px solid var(--border-color);
        }
        .calendar-grid .day-cell:nth-child(8n) { border-right: none; }
        .calendar-grid .day-cell:nth-last-child(-n+8) { border-bottom: none; }
        .calendar-grid .day-cell:hover:not(.other-month):not(.week-number-cell) { background-color: var(--button-hover-bg); }
        .day-number {
            font-size: 0.875rem;
            font-weight: 500;
            width: 1.75rem;
            height: 1.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 9999px;
            margin-bottom: 0.25rem;
            flex-shrink: 0;
        }
        .current-day .day-number { background-color: var(--accent-color); color: var(--accent-text-color); }
        .other-month { color: var(--text-medium-color); opacity: 0.7; cursor: default; }
        .other-month:hover { background-color: transparent; }

        .shift-indicator {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.05rem 0.3rem;
            border-radius: 0.2rem;
            margin-top: 0.15rem;
            width: calc(100% - 0.5rem);
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .note-text {
            font-size: 0.65rem;
            color: var(--note-text-color);
            margin-top: 0.15rem;
            width: calc(100% - 0.5rem);
            text-align: left;
            overflow-wrap: break-word;
            white-space: normal;
            line-height: 1.2;
            font-weight: 600;
            max-height: 2.4em; /* Limit to ~2 lines */
            overflow: hidden;
        }
        .day-cell-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            flex-grow: 1;
            justify-content: flex-start;
            overflow: hidden;
        }

        .shift-M { background-color: var(--shift-m-bg); color: var(--shift-text-light); }
        .shift-T { background-color: var(--shift-t-bg); color: var(--shift-text-dark); }
        .shift-N { background-color: var(--shift-n-bg); color: var(--shift-text-light); }
        .shift-L { background-color: var(--shift-l-bg); color: var(--shift-text-dark); }

        #shiftSelector {
            background-color: var(--card-color);
            padding: 0.75rem;
            border-radius: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1.5rem;
            max-width: 42rem;
            margin-left: auto;
            margin-right: auto;
            border: 1px solid var(--border-color);
        }
        .shift-button {
            padding: 0.5rem 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: border-color 0.2s ease, background-color 0.2s ease;
            min-width: 4rem;
            text-align: center;
            color: var(--text-color);
        }
        .shift-button.active { border-color: var(--accent-color); box-shadow: 0 0 0 2px var(--accent-color); }
        .shift-button:hover:not(.active) { border-color: var(--text-medium-color); background-color: var(--button-hover-bg); }
        .shift-button.erase { background-color: var(--cancel-button-bg); color: var(--cancel-button-text); border-color: transparent; }
        .shift-button.erase:hover { filter: brightness(0.9); }

        .selecting-pattern .day-cell:not(.other-month):not(.week-number-cell) { box-shadow: inset 0 0 0 2px var(--accent-color); }
        .pattern-start-date, .pattern-end-date { background-color: var(--accent-color) !important; color: var(--accent-text-color) !important; }
        .pattern-start-date .day-number, .pattern-end-date .day-number { background-color: transparent !important; color: inherit !important; }

        #patternControls {
            background-color: var(--card-color);
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            align-items: center;
            max-width: 42rem;
            margin-left: auto;
            margin-right: auto;
            border: 1px solid var(--border-color);
        }
        #patternSelectionArea, #patternApplyArea { display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center; justify-content: center; width: 100%; }
        #patternControls.pattern-selecting-active #patternSelectionArea { flex-direction: column; gap: 0.5rem; }
        #patternInfo {
            font-weight: 600;
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
            background-color: var(--bg-color);
            border: 1px dashed var(--border-color);
            border-radius: 0.375rem;
            margin-top: 0.25rem;
            color: var(--text-color);
            width: auto;
            max-width: 90%;
            text-align: center;
        }
        .pattern-button {
            padding: 0.5rem 1rem;
            background-color: var(--accent-color);
            color: var(--accent-text-color);
            border: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s ease;
        }
        .pattern-button.cancel, .pattern-button.selecting { background-color: var(--cancel-button-bg); color: var(--cancel-button-text); }
        .pattern-button:hover { opacity: 0.85; }
        #selectedPatternDisplay {
            font-size: 0.8rem;
            color: var(--text-medium-color);
            background-color: var(--bg-color);
            padding: 0.3rem 0.6rem;
            border-radius: 0.25rem;
            word-break: break-all;
            text-align: center;
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            min-height: 1.5rem;
            border: 1px solid var(--border-color);
        }
        #applyUntilDate {
            padding: 0.4rem 0.6rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 0.875rem;
            color-scheme: dark;
        }
        body.light-mode #applyUntilDate { color-scheme: light; }
        #applySelectedPatternBtn {
            padding: 0.5rem 1rem;
            background-color: var(--accent-color);
            color: var(--accent-text-color);
            border: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s ease;
        }
        #applySelectedPatternBtn:hover { filter: brightness(1.1); }
        #applySelectedPatternBtn:disabled { opacity: 0.5; cursor: not-allowed; }

        #prevMonth, #nextMonth {
            background-color: transparent;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            padding: 0.3rem 0.6rem;
            transition: background-color 0.2s ease;
            color: var(--text-medium-color);
        }
        #prevMonth:hover, #nextMonth:hover { background-color: var(--button-hover-bg); color: var(--text-color); }

        .footer-notes { margin-top: 1.5rem; text-align: center; max-width: 42rem; margin: 0 auto; }
        .footer-notes p { font-size: 0.875rem; color: var(--text-medium-color); margin: 0; }

        #tutorialOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
        #tutorialModal { background-color: var(--card-color); color: var(--text-color); padding: 1.5rem 2rem; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.2); max-width: 95%; width: 550px; z-index: 1001; border: 1px solid var(--border-color); max-height: 80vh; overflow-y: auto; }
        #tutorialModal h3 { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; text-align: center; }
        #tutorialModal p, #tutorialModal ul { font-size: 0.95rem; margin-bottom: 1rem; line-height: 1.6; }
        #tutorialModal ul { list-style: disc; padding-left: 1.5rem; }
        #tutorialModal li { margin-bottom: 0.5rem; }
        #tutorialModal strong { font-weight: 600; color: var(--accent-color); }
        #tutorialModal .tutorial-nav { display: flex; justify-content: flex-end; margin-top: 1.5rem; }
        .tutorial-button { padding: 0.6rem 1.2rem; border: none; border-radius: 0.375rem; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s ease; }
        .tutorial-button.primary { background-color: var(--accent-color); color: var(--accent-text-color); }
        .tutorial-button.primary:hover { filter: brightness(1.1); }
    </style>
</head>
<body class="">
    <div class="main-container">
        <div class="app-header">
            <div class="header-actions-left">
                <a href="../../index.html" class="back-link-header" title="Volver a GUARD-IA">
                    <i class="fas fa-arrow-left"></i>
                    <h2>Volver a GUARD-IA</h2>
                </a>
            </div>
            <div class="header-actions-right">
                <button id="startTutorialBtn" class="header-button" title="Iniciar guía interactiva">
                    <i class="fas fa-question-circle"></i>
                    <span class="hidden sm:inline">Guía</span>
                </button>
                <button id="themeToggleBtn" class="header-button" title="Cambiar tema">
                    <!-- Icono y texto se llenan con JS -->
                </button>
            </div>
        </div>

        <h1 class="main-title">Calendario del GUARD-IA</h1>

        <div id="auth-state">
            <p>Conectando con la nube...</p>
        </div>

        <div id="app-content" class="hidden">
            <div id="calendarManagement">
                <label for="calendarSelector">Calendario:</label>
                <select id="calendarSelector"></select>
                <label for="newCalendarName">Nuevo:</label>
                <input type="text" id="newCalendarName" placeholder="Nombre del calendario...">
                <button id="addCalendarBtn" class="management-button" title="Añadir nuevo calendario">
                    <i class="fas fa-plus"></i> Añadir
                </button>
                <button id="deleteCalendarBtn" class="management-button" title="Eliminar calendario seleccionado" disabled>
                    <i class="fas fa-trash-alt"></i> Eliminar
                </button>
            </div>

            <div id="mainCalendarArea" style="display: none;">
                <div class="calendar-container">
                    <div class="flex justify-between items-center mb-4">
                        <button id="prevMonth" aria-label="Mes anterior"><i class="fas fa-chevron-left"></i></button>
                        <h2 id="currentMonthYear" class="text-xl sm:text-2xl font-semibold text-center flex-grow mx-2"></h2>
                        <button id="nextMonth" aria-label="Mes siguiente"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div id="calendarGridHeader" class="calendar-grid-header"></div>
                    <div id="calendarGrid" class="calendar-grid"></div>
                </div>

                <div class="text-center mt-4">
                    <button id="toggleEditControlsBtn" class="px-4 py-2 rounded-md bg-[var(--card-color)] text-[var(--text-color)] hover:bg-[var(--button-hover-bg)] text-sm font-medium">
                        <i class="fas fa-edit mr-1"></i> Editar Turnos/Patrón
                    </button>
                </div>

                <div id="editControlsWrapper" style="display: none;">
                    <div id="shiftSelector">
                        <span class="text-sm font-medium mr-2 self-center">Asignar Turno:</span>
                        <button class="shift-button erase" data-shift-type="erase" title="Borrar turno"><i class="fas fa-eraser mr-1"></i> Borrar</button>
                    </div>

                    <div id="patternControls">
                        <div id="patternSelectionArea">
                            <span class="text-sm font-medium mr-2">Repetir Patrón:</span>
                            <button id="startPatternSelectionBtn" class="pattern-button">Seleccionar Patrón</button>
                            <span id="patternInfo"></span>
                        </div>
                        <div id="patternApplyArea" class="hidden mt-2">
                            <div id="selectedPatternDisplay" class="mb-2 w-full text-center"></div>
                            <div class="flex flex-wrap gap-2 justify-center items-center w-full">
                                <label for="applyUntilDate" class="text-sm font-medium whitespace-nowrap">Extender hasta:</label>
                                <input type="date" id="applyUntilDate" class="text-sm">
                                <button id="applySelectedPatternBtn" class="pattern-button" disabled>Aplicar</button>
                                <button id="cancelPatternSelectionBtn" class="pattern-button cancel">Cancelar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="footer-notes">
                <p>(Selecciona o crea un calendario para empezar)</p>
            </div>
        </div>
    </div>

    <div id="tutorialOverlay">
        <div id="tutorialModal">
            <h3>Guía Rápida</h3>
            <div id="tutorialContent">
                <p>¡Bienvenido al Gestor de Calendarios! Aquí tienes un resumen rápido:</p>
                <ul>
                    <li><strong>Volver:</strong> Pulsa <i class="fas fa-arrow-left"></i> para volver a la página principal de GUARD-IA.</li>
                    <li><strong>Crear/Seleccionar/Eliminar Calendario:</strong> Usa los controles superiores para añadir (<i class="fas fa-plus"></i>), elegir (selector) o borrar (<i class="fas fa-trash-alt"></i>) un calendario.</li>
                    <li><strong>Navegar:</strong> Usa las flechas <i class="fas fa-chevron-left"></i> <i class="fas fa-chevron-right"></i> para cambiar de mes.</li>
                    <li><strong>Editar Turnos/Patrón:</strong> Pulsa el botón <strong><i class="fas fa-edit"></i> Editar Turnos/Patrón</strong> debajo del calendario para mostrar las opciones de edición.</li>
                    <li><strong>Asignar Turno:</strong>
                        <ol class="list-decimal list-inside pl-4 mt-1">
                            <li>(Asegúrate de que los controles de edición estén visibles)</li>
                            <li>Selecciona un tipo de turno (Mañana, Tarde, Noche, Libre) o 'Borrar' en la sección <strong>'Asignar Turno'</strong>.</li>
                            <li>Haz clic en los días del calendario para aplicar o borrar el turno seleccionado.</li>
                        </ol>
                    </li>
                    <li><strong>Añadir/Editar Nota:</strong>
                        <ol class="list-decimal list-inside pl-4 mt-1">
                            <li>(Asegúrate de que los controles de edición estén visibles)</li>
                            <li>Asegúrate de que <strong>ningún turno esté seleccionado</strong> (ningún botón resaltado en 'Asignar Turno').</li>
                            <li>Haz clic en el día deseado.</li>
                            <li>Escribe tu nota en la ventana que aparece (o bórrala para eliminarla).</li>
                            <li>El texto de la nota aparecerá en la celda (limitado a 2 líneas). Pasa el ratón sobre la celda para ver la nota completa (en escritorio).</li>
                        </ol>
                    </li>
                    <li><strong>Repetir Patrón:</strong>
                        <ol class="list-decimal list-inside pl-4 mt-1">
                            <li>(Asegúrate de que los controles de edición estén visibles)</li>
                            <li>Asigna los turnos base en el calendario.</li>
                            <li>En la sección "Repetir Patrón", pulsa <strong>'Seleccionar Patrón'</strong>.</li>
                            <li>Clic en día de <strong>inicio</strong> y día de <strong>fin</strong> del patrón.</li>
                            <li>Elige fecha <strong>'Extender hasta'</strong> y pulsa <strong>'Aplicar'</strong> (solo aplicará los turnos).</li>
                        </ol>
                    </li>
                    <li><strong>Guía y Tema:</strong> Usa los botones <i class="fas fa-question-circle"></i> y <i class="fas fa-sun"></i> / <i class="fas fa-moon"></i> en la cabecera.</li>
                </ul>
            </div>
            <div class="tutorial-nav">
                <button id="tutorialCloseBtn" class="tutorial-button primary">Entendido</button>
            </div>
        </div>
    </div>

<script type="module">
    // Firebase SDK Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, collection, onSnapshot, 
        doc, setDoc, deleteDoc, addDoc, writeBatch, deleteField, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAf3I3_aW__lBtTVlEJ9xesIWkEJ6lMJp8",
        authDomain: "guard-ia-a36da.firebaseapp.com",
        projectId: "guard-ia-a36da",
        storageBucket: "guard-ia-a36da.appspot.com",
        messagingSenderId: "914018061004",
        appId: "1:914018061004:web:6ab6c6ca728199033bd069",
        measurementId: "G-W45Z1BH3T4"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Constants
    const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
    const shiftTypes = {
        'M': { label: 'Mañana', colorClass: 'shift-M' },
        'T': { label: 'Tarde', colorClass: 'shift-T' },
        'N': { label: 'Noche', colorClass: 'shift-N' },
        'L': { label: 'Libre', colorClass: 'shift-L' },
    };
    const THEME_KEY = 'multiCalendarTheme';
    const TUTORIAL_COMPLETED_KEY = 'multiCalendarTutorialCompleted_v3';

    // UI Elements
    const elements = {
        calendarGridHeader: document.getElementById('calendarGridHeader'),
        calendarGrid: document.getElementById('calendarGrid'),
        currentMonthYear: document.getElementById('currentMonthYear'),
        prevMonth: document.getElementById('prevMonth'),
        nextMonth: document.getElementById('nextMonth'),
        shiftSelector: document.getElementById('shiftSelector'),
        patternControls: document.getElementById('patternControls'),
        applyUntilDate: document.getElementById('applyUntilDate'),
        applySelectedPatternBtn: document.getElementById('applySelectedPatternBtn'),
        startPatternSelectionBtn: document.getElementById('startPatternSelectionBtn'),
        patternSelectionArea: document.getElementById('patternSelectionArea'),
        patternApplyArea: document.getElementById('patternApplyArea'),
        patternInfo: document.getElementById('patternInfo'),
        selectedPatternDisplay: document.getElementById('selectedPatternDisplay'),
        cancelPatternSelectionBtn: document.getElementById('cancelPatternSelectionBtn'),
        calendarSelector: document.getElementById('calendarSelector'),
        newCalendarName: document.getElementById('newCalendarName'),
        addCalendarBtn: document.getElementById('addCalendarBtn'),
        deleteCalendarBtn: document.getElementById('deleteCalendarBtn'),
        mainCalendarArea: document.getElementById('mainCalendarArea'),
        footerStatus: document.querySelector('.footer-notes p'),
        startTutorialBtn: document.getElementById('startTutorialBtn'),
        themeToggleBtn: document.getElementById('themeToggleBtn'),
        tutorialOverlay: document.getElementById('tutorialOverlay'),
        tutorialCloseBtn: document.getElementById('tutorialCloseBtn'),
        toggleEditControlsBtn: document.getElementById('toggleEditControlsBtn'),
        editControlsWrapper: document.getElementById('editControlsWrapper'),
        authState: document.getElementById('auth-state'),
        appContent: document.getElementById('app-content'),
    };

    // Application State
    let state = {
        currentDate: new Date(),
        selectedShiftType: null,
        calendars: {},
        activeCalendarId: null,
        shiftData: {},
        isSelectingPattern: false,
        patternStartDate: null,
        patternEndDate: null,
        selectedPatternSequence: [],
        currentUserId: null,
        unsubscribeCalendars: null,
        unsubscribeShifts: null,
    };

    // Authentication
    const waitForAuthInit = () => new Promise((resolve) => {
        const unsubscribe = onAuthStateChanged(auth, (user) => {
            unsubscribe();
            resolve(user);
        });
    });

    async function initializeAppForUser(user) {
        if (!user) return showLoginScreen();
        state.currentUserId = user.uid;
        elements.authState.classList.add('hidden');
        elements.appContent.classList.remove('hidden');
        await listenForUserCalendars();
    }

    function showLoginScreen() {
        elements.authState.innerHTML = `<p>Debes iniciar sesión para usar el calendario. <a href="../../index.html">Volver a la página principal para iniciar sesión.</a></p>`;
        elements.authState.classList.remove('hidden');
        elements.appContent.classList.add('hidden');
    }

    // Theme and Tutorial
    function applyTheme(theme) {
        document.body.classList.toggle('light-mode', theme === 'light');
        const isLight = theme === 'light';
        elements.themeToggleBtn.innerHTML = `<i class="fas ${isLight ? 'fa-moon' : 'fa-sun'}"></i> <span class="hidden sm:inline">${isLight ? 'Oscuro' : 'Claro'}</span>`;
        localStorage.setItem(THEME_KEY, theme);
    }

    function showTutorial() { elements.tutorialOverlay.style.display = 'flex'; }
    function hideTutorial(markAsCompleted = true) {
        elements.tutorialOverlay.style.display = 'none';
        if (markAsCompleted) localStorage.setItem(TUTORIAL_COMPLETED_KEY, 'true');
    }

    // Date Helpers
    function formatDate(date) {
        return date.toISOString().split('T')[0];
    }

    function parseDate(dateString) {
        const date = new Date(dateString + 'T12:00:00Z');
        return isNaN(date.getTime()) ? null : date;
    }

    function getWeekNumber(date) {
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    // Firestore Functions
    async function listenForUserCalendars() {
        if (!state.currentUserId) return;
        if (state.unsubscribeCalendars) state.unsubscribeCalendars();

        const calendarsRef = collection(db, 'users', state.currentUserId, 'calendars');
        state.unsubscribeCalendars = onSnapshot(calendarsRef, (snapshot) => {
            state.calendars = {};
            snapshot.forEach((docSnap) => {
                state.calendars[docSnap.id] = docSnap.data();
            });
            updateCalendarSelector();
            const lastActive = localStorage.getItem(`lastActiveCal_${state.currentUserId}`);
            if (lastActive && state.calendars[lastActive]) {
                selectCalendar(lastActive);
            } else if (Object.keys(state.calendars).length > 0) {
                selectCalendar(Object.keys(state.calendars)[0]);
            } else {
                showMainCalendarArea(false);
            }
        });
    }

    function listenForShiftData(calendarId) {
        if (!state.currentUserId || !calendarId) return;
        if (state.unsubscribeShifts) state.unsubscribeShifts();

        const shiftsRef = collection(db, 'users', state.currentUserId, 'calendars', calendarId, 'shifts');
        state.shiftData = {};
        state.unsubscribeShifts = onSnapshot(shiftsRef, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === 'added' || change.type === 'modified') {
                    state.shiftData[change.doc.id] = change.doc.data();
                } else if (change.type === 'removed') {
                    delete state.shiftData[change.doc.id];
                }
            });
            renderCalendar(state.currentDate.getFullYear(), state.currentDate.getMonth());
        });
    }

    async function addCalendar() {
        const name = elements.newCalendarName.value.trim();
        if (!name || !state.currentUserId) return;

        try {
            const calendarsRef = collection(db, 'users', state.currentUserId, 'calendars');
            const newRef = await addDoc(calendarsRef, { name, createdAt: serverTimestamp() });
            elements.newCalendarName.value = '';
            selectCalendar(newRef.id);
        } catch (error) {
            console.error('Error adding calendar:', error);
            alert('No se pudo añadir el calendario.');
        }
    }

    async function deleteCalendar() {
        const id = elements.calendarSelector.value;
        if (!id || !state.currentUserId) return;
        if (!confirm(`¿Seguro que quieres eliminar "${state.calendars[id].name}"?`)) return;

        try {
            await deleteDoc(doc(db, 'users', state.currentUserId, 'calendars', id));
        } catch (error) {
            console.error('Error deleting calendar:', error);
            alert('No se pudo eliminar el calendario.');
        }
    }

    async function saveShiftData(dateString, data) {
        if (!state.currentUserId || !state.activeCalendarId) return;
        const shiftRef = doc(db, 'users', state.currentUserId, 'calendars', state.activeCalendarId, 'shifts', dateString);

        try {
            if (!data.shift && !data.note) {
                await deleteDoc(shiftRef);
            } else {
                await setDoc(shiftRef, data, { merge: true });
            }
        } catch (error) {
            console.error('Error saving shift:', error);
        }
    }

    // UI Updates
    function updateCalendarSelector() {
        const ids = Object.keys(state.calendars).sort((a, b) => state.calendars[a].name.localeCompare(state.calendars[b].name));
        elements.calendarSelector.innerHTML = '';
        if (ids.length === 0) {
            elements.calendarSelector.innerHTML = '<option>Crea un calendario</option>';
            elements.calendarSelector.disabled = true;
            elements.deleteCalendarBtn.disabled = true;
        } else {
            ids.forEach((id) => {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = state.calendars[id].name;
                elements.calendarSelector.appendChild(option);
            });
            elements.calendarSelector.disabled = false;
            elements.deleteCalendarBtn.disabled = false;
        }
        if (state.activeCalendarId) elements.calendarSelector.value = state.activeCalendarId;
    }

    function showMainCalendarArea(show) {
        elements.mainCalendarArea.style.display = show ? 'block' : 'none';
        elements.footerStatus.textContent = show ? `Calendario: ${state.calendars[state.activeCalendarId]?.name || ''}` : '(Selecciona o crea un calendario)';
        elements.toggleEditControlsBtn.style.display = show ? 'block' : 'none';
    }

    // Calendar Rendering
    function renderCalendar(year, month) {
        if (!state.activeCalendarId) return;
        elements.currentMonthYear.textContent = `${monthNames[month]} ${year}`;
        elements.calendarGridHeader.innerHTML = '<div>Sem</div>' + ['L', 'M', 'M', 'J', 'V', 'S', 'D'].map((d) => `<div>${d}</div>`).join('');
        elements.calendarGrid.innerHTML = '';

        const firstDay = new Date(year, month, 1);
        let mondayOffset = (firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1);
        let currentMonday = new Date(firstDay);
        currentMonday.setDate(firstDay.getDate() - mondayOffset);

        const today = formatDate(new Date());

        for (let week = 0; week < 6; week++) {
            const weekCell = document.createElement('div');
            weekCell.className = 'day-cell week-number-cell';
            weekCell.textContent = getWeekNumber(currentMonday);
            elements.calendarGrid.appendChild(weekCell);

            for (let day = 0; day < 7; day++) {
                const cellDate = new Date(currentMonday);
                cellDate.setDate(currentMonday.getDate() + day);
                const dateStr = formatDate(cellDate);
                const cell = document.createElement('div');
                cell.className = 'day-cell';
                cell.dataset.date = dateStr;

                const dayNum = document.createElement('span');
                dayNum.className = 'day-number';
                dayNum.textContent = cellDate.getDate();

                if (cellDate.getMonth() !== month) cell.classList.add('other-month');
                if (dateStr === today) cell.classList.add('current-day');

                cell.addEventListener('click', () => handleDayClick(dateStr, cell));

                const content = document.createElement('div');
                content.className = 'day-cell-content';

                const dayData = state.shiftData[dateStr];
                if (dayData?.shift && shiftTypes[dayData.shift]) {
                    const shiftInd = document.createElement('div');
                    shiftInd.className = `shift-indicator ${shiftTypes[dayData.shift].colorClass}`;
                    shiftInd.textContent = dayData.shift;
                    content.appendChild(shiftInd);
                }
                if (dayData?.note) {
                    const note = document.createElement('div');
                    note.className = 'note-text';
                    note.textContent = dayData.note;
                    content.appendChild(note);
                    cell.title = dayData.note;
                }

                cell.appendChild(dayNum);
                cell.appendChild(content);
                elements.calendarGrid.appendChild(cell);
            }
            currentMonday.setDate(currentMonday.getDate() + 7);
        }
        highlightPatternSelection();
    }

    function handleDayClick(dateStr, cell) {
        if (!state.activeCalendarId || (cell.classList.contains('other-month') && !state.isSelectingPattern)) return;
        const controlsVisible = elements.editControlsWrapper.style.display !== 'none';

        if (state.isSelectingPattern) {
            handlePatternSelectionClick(dateStr);
        } else if (controlsVisible && state.selectedShiftType) {
            applySingleShift(dateStr);
        } else if (controlsVisible) {
            manageNoteForDay(dateStr);
        }
    }

    function applySingleShift(dateStr) {
        const current = state.shiftData[dateStr] || {};
        const newData = { ...current };
        if (state.selectedShiftType === 'erase') {
            delete newData.shift;
        } else {
            newData.shift = state.selectedShiftType;
        }
        saveShiftData(dateStr, newData);
    }

    function manageNoteForDay(dateStr) {
        const currentNote = state.shiftData[dateStr]?.note || '';
        const newNote = prompt(`Nota para ${dateStr} (vacío para borrar):`, currentNote);
        if (newNote === null) return;

        const current = state.shiftData[dateStr] || {};
        const newData = { ...current };
        if (newNote.trim() === '') {
            delete newData.note;
        } else {
            newData.note = newNote.trim();
        }
        saveShiftData(dateStr, newData);
    }

    async function applySelectedPattern() {
        const until = elements.applyUntilDate.value;
        if (!until || !state.patternEndDate || state.selectedPatternSequence.length === 0) return;

        let patternEnd = parseDate(state.patternEndDate);
        let repeatStart = new Date(patternEnd);
        repeatStart.setDate(repeatStart.getDate() + 1);
        let untilDate = parseDate(until);

        if (repeatStart > untilDate) return alert("'Extender hasta' debe ser posterior al fin del patrón.");

        const batch = writeBatch(db);
        let index = 0;
        let current = new Date(repeatStart);

        while (current <= untilDate) {
            const dateStr = formatDate(current);
            const shift = state.selectedPatternSequence[index % state.selectedPatternSequence.length];
            const ref = doc(db, 'users', state.currentUserId, 'calendars', state.activeCalendarId, 'shifts', dateStr);

            if (shift) {
                batch.set(ref, { shift }, { merge: true });
            } else {
                batch.update(ref, { shift: deleteField() });
            }

            current.setDate(current.getDate() + 1);
            index++;
        }

        try {
            await batch.commit();
            alert('Patrón aplicado exitosamente.');
            cancelPatternSelection(true);
        } catch (error) {
            console.error('Error applying pattern:', error);
            alert('Error al aplicar el patrón.');
        }
    }

    // Other Logic
    function selectCalendar(id) {
        if (!state.calendars[id]) return;
        state.activeCalendarId = id;
        localStorage.setItem(`lastActiveCal_${state.currentUserId}`, id);
        updateCalendarSelector();
        showMainCalendarArea(true);
        listenForShiftData(id);
        cancelPatternSelection(true);
        elements.editControlsWrapper.style.display = 'none';
    }

    function createShiftButtons() {
        const eraseBtn = elements.shiftSelector.querySelector('.erase');
        Object.entries(shiftTypes).forEach(([key, { label, colorClass }]) => {
            const btn = document.createElement('button');
            btn.className = `shift-button ${colorClass}`;
            btn.dataset.shiftType = key;
            btn.textContent = label;
            btn.title = `Asignar: ${label}`;
            btn.addEventListener('click', () => selectShift(key, btn));
            elements.shiftSelector.insertBefore(btn, eraseBtn);
        });
        eraseBtn.addEventListener('click', () => selectShift('erase', eraseBtn));
    }

    function selectShift(key, btn) {
        if (state.isSelectingPattern) cancelPatternSelection(true);

        if (state.selectedShiftType === key) {
            state.selectedShiftType = null;
            btn.classList.remove('active');
        } else {
            state.selectedShiftType = key;
            elements.shiftSelector.querySelectorAll('.shift-button').forEach((b) => b.classList.remove('active'));
            btn.classList.add('active');
        }
    }

    function highlightPatternSelection() {
        document.querySelectorAll('.pattern-start-date, .pattern-end-date').forEach((c) => c.classList.remove('pattern-start-date', 'pattern-end-date'));
        if (state.patternStartDate) document.querySelector(`[data-date="${state.patternStartDate}"]`)?.classList.add('pattern-start-date');
        if (state.patternEndDate) document.querySelector(`[data-date="${state.patternEndDate}"]`)?.classList.add('pattern-end-date');
    }

    function cancelPatternSelection(clear = true) {
        state.isSelectingPattern = false;
        state.patternStartDate = null;
        state.patternEndDate = null;
        if (clear) {
            state.selectedPatternSequence = [];
            elements.applyUntilDate.value = '';
            elements.selectedPatternDisplay.innerHTML = '';
            elements.applySelectedPatternBtn.disabled = true;
        }
        elements.patternControls.classList.remove('pattern-selecting-active');
        elements.startPatternSelectionBtn.textContent = 'Seleccionar Patrón';
        elements.startPatternSelectionBtn.classList.remove('selecting');
        elements.patternInfo.textContent = '';
        elements.calendarGrid.classList.remove('selecting-pattern');
        highlightPatternSelection();
        elements.patternApplyArea.classList.add('hidden');
        elements.patternSelectionArea.classList.remove('hidden');
    }

    function handlePatternSelectionClick(dateStr) {
        if (!state.patternStartDate) {
            state.patternStartDate = dateStr;
            elements.patternInfo.textContent = 'CLIC DÍA FIN PATRÓN.';
        } else {
            state.patternEndDate = dateStr;
            let start = parseDate(state.patternStartDate);
            let end = parseDate(state.patternEndDate);

            if (start > end) {
                [start, end] = [end, start];
                [state.patternStartDate, state.patternEndDate] = [formatDate(start), formatDate(end)];
            }

            state.selectedPatternSequence = [];
            let iter = new Date(start);
            while (iter <= end) {
                const str = formatDate(iter);
                state.selectedPatternSequence.push(state.shiftData[str]?.shift || null);
                iter.setDate(iter.getDate() + 1);
            }

            state.isSelectingPattern = false;
            elements.patternControls.classList.remove('pattern-selecting-active');
            elements.calendarGrid.classList.remove('selecting-pattern');
            elements.startPatternSelectionBtn.textContent = 'Sel. Otro Patrón';
            elements.patternApplyArea.classList.remove('hidden');
            elements.patternSelectionArea.classList.add('hidden');
            elements.selectedPatternDisplay.innerHTML = `Patrón: ${state.selectedPatternSequence.map((s) => `<span class="font-bold ${s ? shiftTypes[s].colorClass : ''} px-1 rounded">${s || '-'}</span>`).join(' ')}`;
            elements.applySelectedPatternBtn.disabled = elements.applyUntilDate.value === '';
        }
        highlightPatternSelection();
    }

    // Initializer
    async function init() {
        applyTheme(localStorage.getItem(THEME_KEY) || 'dark');
        createShiftButtons();
        if (!localStorage.getItem(TUTORIAL_COMPLETED_KEY)) setTimeout(showTutorial, 500);

        try {
            const user = await waitForAuthInit();
            await initializeAppForUser(user);
        } catch (error) {
            console.error('Auth init failed:', error);
            showLoginScreen();
        }

        // Event Listeners
        elements.addCalendarBtn.addEventListener('click', addCalendar);
        elements.deleteCalendarBtn.addEventListener('click', deleteCalendar);
        elements.calendarSelector.addEventListener('change', (e) => selectCalendar(e.target.value));
        elements.prevMonth.addEventListener('click', () => {
            state.currentDate.setMonth(state.currentDate.getMonth() - 1);
            renderCalendar(state.currentDate.getFullYear(), state.currentDate.getMonth());
        });
        elements.nextMonth.addEventListener('click', () => {
            state.currentDate.setMonth(state.currentDate.getMonth() + 1);
            renderCalendar(state.currentDate.getFullYear(), state.currentDate.getMonth());
        });
        elements.toggleEditControlsBtn.addEventListener('click', () => {
            elements.editControlsWrapper.style.display = elements.editControlsWrapper.style.display === 'none' ? 'block' : 'none';
        });
        elements.startPatternSelectionBtn.addEventListener('click', () => {
            if (state.isSelectingPattern) return cancelPatternSelection(true);

            state.selectedShiftType = null;
            elements.shiftSelector.querySelectorAll('.shift-button.active').forEach((b) => b.classList.remove('active'));

            state.isSelectingPattern = true;
            state.patternStartDate = null;
            state.patternEndDate = null;
            state.selectedPatternSequence = [];
            elements.patternControls.classList.add('pattern-selecting-active');
            elements.patternInfo.textContent = 'CLIC DÍA INICIO PATRÓN...';
            elements.startPatternSelectionBtn.textContent = 'Cancelar';
            elements.startPatternSelectionBtn.classList.add('selecting');
            elements.calendarGrid.classList.add('selecting-pattern');
            elements.patternApplyArea.classList.add('hidden');
            elements.patternSelectionArea.classList.remove('hidden');
        });
        elements.cancelPatternSelectionBtn.addEventListener('click', () => cancelPatternSelection(true));
        elements.applyUntilDate.addEventListener('change', () => {
            elements.applySelectedPatternBtn.disabled = elements.applyUntilDate.value === '' || state.selectedPatternSequence.length === 0;
        });
        elements.applySelectedPatternBtn.addEventListener('click', applySelectedPattern);
        elements.themeToggleBtn.addEventListener('click', () => applyTheme(document.body.classList.contains('light-mode') ? 'dark' : 'light'));
        elements.startTutorialBtn.addEventListener('click', showTutorial);
        elements.tutorialCloseBtn.addEventListener('click', hideTutorial);
    }

    init();
</script>
</body>
</html>
