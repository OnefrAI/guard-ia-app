<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Turnos Multi-Calendario</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Variables de Color --- */
        :root {
            /* Modo Oscuro */
            --bg-color: #121212; --card-color: #1e1e1e; --text-color: #e0e0e0; --text-medium-color: #a0a0a0;
            --accent-color: #39FF14; --accent-text-color: #0a0a0a; --border-color: rgba(255, 255, 255, 0.15);
            --cell-border-color: rgba(255, 255, 255, 0.1); --button-hover-bg: rgba(255, 255, 255, 0.08);
            --cancel-button-bg: #b91c1c; --cancel-button-text: #ffffff; --week-number-color: var(--text-medium-color);
            --current-week-bg: rgba(255, 255, 255, 0.04); --event-indicator-color: #ffd700;
            --tooltip-bg: #333333; --tooltip-text: #f0f0f0; --summary-text-color: var(--text-color);
            --modal-overlay-bg: rgba(0, 0, 0, 0.7); --modal-bg: var(--card-color); --modal-border: var(--border-color);
            --input-bg: #2a2a2a; --input-border: var(--border-color); --input-text: var(--text-color);
            --input-focus-border: var(--accent-color); --checkbox-accent: var(--accent-color);
            --header-button-text-color: var(--text-medium-color); --header-button-hover-text-color: var(--text-color);
            --bottom-bar-bg: var(--card-color); --bottom-bar-border: var(--border-color);
            --mobile-menu-bg: #2a2a2a; --menu-section-border: rgba(255, 255, 255, 0.1);
            --pattern-range-bg: rgba(57, 255, 20, 0.1); --menu-overlay-bg: rgba(0, 0, 0, 0.5);
            --highlight-glow-color: rgba(57, 255, 20, 0.5);

            /* Mapeo */
            --calendar-bg: var(--card-color); --calendar-text: var(--text-color); --calendar-border: var(--border-color);
            --day-hover-bg: var(--button-hover-bg); --current-day-bg: var(--accent-color); --current-day-text: var(--accent-text-color);
            --nav-button-hover: var(--button-hover-bg); --other-month-text: #666666; --shift-selector-bg: var(--card-color);
            --shift-button-border: var(--border-color); --shift-button-active-border: var(--accent-color);
            --apply-button-bg: var(--accent-color); --apply-button-text: var(--accent-text-color);
            --pattern-select-bg: var(--accent-color); --pattern-select-text: var(--accent-text-color);
            --pattern-display-bg: var(--bg-color); --pattern-controls-bg: var(--card-color);
            --select-bg: var(--input-bg); --select-text: var(--text-color); --button-primary-bg: var(--accent-color);
            --button-primary-text: var(--accent-text-color); --button-primary-hover-bg: #2aff00;
            --button-secondary-bg: #3a3a3a; --button-secondary-text: var(--text-color); --button-secondary-hover-bg: #4a4a4a;
            --button-delete-bg: var(--cancel-button-bg); --button-delete-text: var(--cancel-button-text);
            --button-delete-hover-bg: #991b1b; --tutorial-overlay-bg: rgba(0, 0, 0, 0.8);
            --tutorial-modal-bg: #1f1f1f; --tutorial-modal-text: var(--text-color); --tutorial-highlight-color: var(--accent-color);
            /* Colores Turnos */
            --shift-m-bg: #2563eb; --shift-t-bg: #d97706; --shift-n-bg: #7c3aed; --shift-l-bg: #059669;
            --shift-text-light: #ffffff; --shift-text-dark: #ffffff; --note-text-color: var(--text-medium-color);
        }
        body.light-mode {
            /* Modo Claro */
             --bg-color: #f8f9fa; --card-color: #ffffff; --text-color: #212529; --text-medium-color: #6c757d;
             --accent-color: #007bff; --accent-text-color: #ffffff; --border-color: rgba(0, 0, 0, 0.1);
             --cell-border-color: rgba(0, 0, 0, 0.15); --button-hover-bg: rgba(0, 0, 0, 0.05);
             --cancel-button-bg: #dc3545; --cancel-button-text: #ffffff; --week-number-color: var(--text-medium-color);
             --current-week-bg: rgba(0, 123, 255, 0.08); --event-indicator-color: #ffc107;
             --tooltip-bg: #f8f9fa; --tooltip-text: #212529; --summary-text-color: var(--text-color);
             --modal-overlay-bg: rgba(0, 0, 0, 0.5); --modal-bg: var(--card-color); --modal-border: var(--border-color);
             --input-bg: var(--card-color); --input-border: var(--border-color); --input-text: var(--text-color);
             --input-focus-border: var(--accent-color); --checkbox-accent: var(--accent-color);
             --header-button-text-color: var(--text-medium-color); --header-button-hover-text-color: var(--text-color);
             --bottom-bar-bg: #f1f3f5; --bottom-bar-border: var(--border-color);
             --mobile-menu-bg: #f1f3f5; --menu-section-border: rgba(0, 0, 0, 0.08);
             --pattern-range-bg: rgba(0, 123, 255, 0.1); --menu-overlay-bg: rgba(0, 0, 0, 0.4);
             --highlight-glow-color: rgba(0, 123, 255, 0.4);
             /* Mapeo */
             --calendar-bg: var(--card-color); --calendar-text: var(--text-color); --calendar-border: var(--border-color);
             --day-hover-bg: #e9ecef; --current-day-bg: var(--accent-color); --current-day-text: var(--accent-text-color);
             --nav-button-hover: var(--button-hover-bg); --other-month-text: #adb5bd; --shift-selector-bg: #f1f3f5;
             --shift-button-border: var(--border-color); --shift-button-active-border: var(--accent-color);
             --apply-button-bg: var(--accent-color); --apply-button-text: var(--accent-text-color);
             --pattern-select-bg: var(--accent-color); --pattern-select-text: var(--accent-text-color);
             --pattern-display-bg: #e9ecef; --pattern-controls-bg: #f1f3f5; --select-bg: var(--input-bg);
             --select-text: var(--text-color); --button-primary-bg: var(--accent-color);
             --button-primary-text: var(--accent-text-color); --button-primary-hover-bg: #0056b3;
             --button-secondary-bg: #e9ecef; --button-secondary-text: var(--text-color); --button-secondary-hover-bg: #dee2e6;
             --button-delete-bg: var(--cancel-button-bg); --button-delete-text: var(--cancel-button-text);
             --button-delete-hover-bg: #c82333; --tutorial-overlay-bg: rgba(0, 0, 0, 0.5);
             --tutorial-modal-bg: var(--card-color); --tutorial-modal-text: var(--text-color);
             --tutorial-highlight-color: var(--accent-color);
             /* Colores Turnos Modo Claro */
             --shift-m-bg: #60a5fa; --shift-t-bg: #fbbf24; --shift-n-bg: #a78bfa; --shift-l-bg: #34d399;
             --shift-text-light: #ffffff; --shift-text-dark: #1f2937; --note-text-color: var(--text-medium-color);
        }

        /* --- Estilos Base & Tipografía --- */
        html { scroll-padding-top: 1rem; }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Inter', sans-serif; transition: background-color 0.3s ease, color 0.3s ease; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; padding-bottom: 60px; }
        .main-container { max-width: 56rem; margin: auto; padding: 1rem; } @media (min-width: 640px) { .main-container { padding: 1.5rem; } } @media (min-width: 1024px) { .main-container { padding: 2rem; max-width: 64rem; } }

        /* --- Título Principal --- */
        .main-title { font-size: 1.3rem; font-weight: 600; text-align: center; margin-bottom: 1rem; color: var(--text-color); } @media (min-width: 640px) { .main-title { font-size: 1.5rem; margin-bottom: 1.5rem;} }

        /* --- Barra Inferior Fija --- */
        #bottomBar { background-color: var(--bottom-bar-bg); border-top: 1px solid var(--bottom-bar-border); padding: 0.5rem 1rem; position: fixed; bottom: 0; left: 0; right: 0; z-index: 900; box-shadow: 0 -2px 5px rgba(0,0,0,0.1); }
        .bottom-bar-content { max-width: 64rem; margin-left: auto; margin-right: auto; display: flex; justify-content: flex-end; align-items: center; gap: 1rem; }
        @media (max-width: 767px) { .bottom-bar-content { justify-content: flex-end; } }

        /* --- Sección Acciones (en barra inferior) --- */
        #bottomActions { display: flex; align-items: center; gap: 0.5rem; }
        .bottom-action-button { background-color: transparent; color: var(--header-button-text-color); padding: 0.4rem 0.5rem; border: none; border-radius: 0; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: color 0.2s ease; display: none; align-items: center; gap: 0.4rem; text-decoration: none; }
        .bottom-action-button i { font-size: 0.9rem; width: auto; }
        .bottom-action-button span { font-size: 0.85rem; }
        .bottom-action-button:disabled { opacity: 0.5; cursor: not-allowed; color: var(--text-medium-color) !important; }
        .bottom-action-button:hover:not(:disabled) { color: var(--header-button-hover-text-color); }
        #menuToggleBtnBottom { background: none; border: none; color: var(--header-button-text-color); font-size: 1.5rem; cursor: pointer; padding: 0.4rem; transition: color 0.2s ease, transform 0.3s ease; }
        #menuToggleBtnBottom:hover { color: var(--header-button-hover-text-color); }
        /* Animación para botón de menú */
        .pulsate-glow { animation: pulsate 1.5s infinite ease-in-out; border-radius: 50%; /* Make glow circular */ }
        @keyframes pulsate { 0% { transform: scale(1); box-shadow: 0 0 0 0 var(--highlight-glow-color); } 70% { transform: scale(1.05); box-shadow: 0 0 10px 5px rgba(0,0,0,0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0,0,0,0); } }

        @media (min-width: 768px) { #menuToggleBtnBottom { display: none; } #bottomActions { gap: 0.8rem; } #editShiftsBtnBottom, #startTutorialBtnBottom, #themeToggleBtnBottom { display: inline-flex; } }
        @media (max-width: 767px) { #editShiftsBtnBottom, #startTutorialBtnBottom, #themeToggleBtnBottom { display: none; } #menuToggleBtnBottom { display: block; } }

        /* --- Menú Móvil --- */
        #mobileMenu { position: fixed; top: 0; left: 0; width: 280px; height: 100%; background-color: var(--mobile-menu-bg); color: var(--text-color); padding: 1rem 0; box-shadow: 2px 0 5px rgba(0,0,0,0.2); z-index: 1100; transform: translateX(-100%); transition: transform 0.3s ease-in-out; display: flex; flex-direction: column; }
        #mobileMenu.open { transform: translateX(0); }
        #mobileMenu .close-btn { position: absolute; top: 0.5rem; right: 0.75rem; background: none; border: none; color: var(--text-color); font-size: 1.8rem; cursor: pointer; padding: 0.25rem; line-height: 1; }
        #mobileMenu .menu-item, #mobileMenu .menu-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1.25rem; color: var(--text-color); text-decoration: none; font-size: 0.95rem; background: none; border: none; width: 100%; text-align: left; cursor: pointer; border-bottom: 1px solid var(--menu-section-border); }
        #mobileMenu .menu-item:hover, #mobileMenu .menu-link:hover { background-color: var(--button-hover-bg); color: var(--accent-color); }
        #mobileMenu .menu-item:disabled { opacity: 0.5; cursor: not-allowed; color: var(--text-medium-color); background-color: transparent !important; }
        #mobileMenu .menu-item:disabled:hover { color: var(--text-medium-color); }
        #mobileMenu .menu-item i, #mobileMenu .menu-link i { width: 20px; text-align: center; margin-right: 0.25rem; }
        .menu-section { margin-top: 0.5rem; border-top: 1px solid var(--menu-section-border); }
        .menu-section:first-child { border-top: none; margin-top: 0;} /* Remove top border/margin for first section */
        .menu-section-title { padding: 0.5rem 1.25rem 0.25rem; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; color: var(--text-medium-color); }
        #mobileMenu .menu-item:last-child, #mobileMenu .menu-link:last-child, .menu-section:last-child .menu-item:last-child, .menu-section:last-child .menu-link:last-child { border-bottom: none; }
        .menu-calendar-management { padding: 0.75rem 1.25rem; border-bottom: 1px solid var(--menu-section-border); }
        .menu-calendar-management label { font-size: 0.8rem; font-weight: 500; color: var(--text-medium-color); margin-bottom: 0.25rem; display: block; }
        .menu-calendar-management select, .menu-calendar-management input { width: 100%; background-color: var(--input-bg); color: var(--input-text); border: 1px solid var(--input-border); border-radius: 0.375rem; padding: 0.4rem 0.6rem; font-size: 0.85rem; margin-bottom: 0.5rem; transition: box-shadow 0.3s ease; }
        .menu-calendar-management select:disabled { opacity: 0.6; }
        .menu-calendar-management .add-delete-buttons { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
        .menu-calendar-management .management-button-menu { padding: 0.4rem 0.7rem; border: none; border-radius: 0.375rem; font-size: 0.8rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s ease, opacity 0.2s ease; display: inline-flex; align-items: center; gap: 0.25rem; flex-grow: 1; justify-content: center; }
        .menu-calendar-management .management-button-menu:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(50%); }
        #addCalendarBtnMobile { background-color: var(--button-primary-bg); color: var(--button-primary-text); } #addCalendarBtnMobile:hover:not(:disabled) { filter: brightness(1.1); }
        #deleteCalendarBtnMobile { background-color: var(--button-delete-bg); color: var(--button-delete-text); } #deleteCalendarBtnMobile:hover:not(:disabled) { background-color: var(--button-delete-hover-bg); }
        /* Highlight for new calendar input */
        .highlight-input { animation: input-glow 1.5s infinite ease-in-out; }
        @keyframes input-glow { 0%, 100% { box-shadow: 0 0 0 0px var(--highlight-glow-color); } 50% { box-shadow: 0 0 0 3px var(--highlight-glow-color); } }

        /* Menu Overlay */
        #menuOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--menu-overlay-bg); display: none; z-index: 1090; }


        /* --- Contenedor Calendario --- */
        .calendar-container { background-color: var(--calendar-bg); color: var(--calendar-text); border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); padding: 1rem; border: 1px solid var(--border-color); } @media (min-width: 640px) { .calendar-container { padding: 1.5rem; } }
        .calendar-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; } #currentMonthYear { text-align: center; font-size: 1.25rem; font-weight: 600; flex-grow: 1; margin: 0 0.5rem; } @media (min-width: 640px) { #currentMonthYear { font-size: 1.5rem; } }
        .nav-button { background-color: transparent; border: 1px solid var(--border-color); border-radius: 0.375rem; padding: 0.3rem 0.6rem; transition: background-color 0.2s ease; color: var(--text-medium-color); font-size: 1rem; line-height: 1; } .nav-button:hover { background-color: var(--nav-button-hover); color: var(--text-color); }
        #goToTodayBtn { font-size: 0.8rem; padding: 0.3rem 0.7rem; margin: 0 0.5rem; }

        /* --- Grid del Calendario y Celdas --- */
        .calendar-grid-header { display: grid; grid-template-columns: repeat(8, minmax(0, 1fr)); text-align: center; font-size: 0.8rem; font-weight: 500; color: var(--text-medium-color); padding-bottom: 0.5rem; margin-bottom: 0.5rem; border-bottom: 1px solid var(--calendar-border); }
        .calendar-grid { display: grid; grid-template-columns: repeat(8, minmax(0, 1fr)); }
        .calendar-grid .day-cell { min-height: 6rem; padding: 0.25rem; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; position: relative; transition: background-color 0.2s ease, box-shadow 0.2s ease; border-right: 1px solid var(--cell-border-color); border-bottom: 1px solid var(--cell-border-color); cursor: pointer; overflow: hidden; }
        .current-week-row { background-color: var(--current-week-bg) !important; } .week-number-cell { color: var(--week-number-color); font-size: 0.75rem; font-weight: 500; cursor: default !important; background-color: transparent !important; align-items: center; justify-content: center; border-right: 1px solid var(--calendar-border); }
        .week-header { font-weight: normal; } .calendar-grid .day-cell:nth-child(8n) { border-right: none; } .calendar-grid .day-cell:nth-last-child(-n+8) { border-bottom: none; }
        .calendar-grid .day-cell:hover:not(.other-month):not(.week-number-cell) { background-color: var(--day-hover-bg); }
        .day-number { font-size: 0.875rem; font-weight: 500; width: 1.75rem; height: 1.75rem; display: flex; align-items: center; justify-content: center; border-radius: 9999px; margin-bottom: 0.25rem; flex-shrink: 0; text-align: center; position: relative; z-index: 1; }
        .current-day .day-number { background-color: var(--current-day-bg); color: var(--current-day-text); } .other-month { color: var(--other-month-text) !important; opacity: 0.7; cursor: default !important; } .other-month:hover { background-color: transparent !important; }
        /* Patrón de selección */
        .pattern-range { background-color: var(--pattern-range-bg); } /* Estilo para días en rango */
        .pattern-start-date .day-number, .pattern-end-date .day-number { background-color: var(--accent-color) !important; color: var(--accent-text-color) !important; }


        /* --- Indicadores de Turno, Nota y Evento --- */
        .shift-indicator { font-size: 0.7rem; font-weight: 600; padding: 0.05rem 0.3rem; border-radius: 0.2rem; margin-top: 0.15rem; width: calc(100% - 0.5rem); text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex-shrink: 0; }
        .note-text { font-size: 0.65rem; color: var(--note-text-color); margin-top: 0.15rem; width: calc(100% - 0.5rem); text-align: left; overflow-wrap: break-word; word-break: break-word; white-space: normal; line-height: 1.2; font-weight: 600; }
        .day-cell-content { display: flex; flex-direction: column; align-items: center; width: 100%; padding-bottom: 0.1rem; flex-grow: 1; justify-content: flex-start; overflow: hidden; position: relative; }
        .event-indicator { position: absolute; top: 2px; right: 2px; font-size: 0.6rem; color: var(--event-indicator-color); z-index: 0; }

        /* Clases de color para turnos */
        .shift-M { background-color: var(--shift-m-bg); color: var(--shift-text-light); } .shift-T { background-color: var(--shift-t-bg); color: var(--shift-text-dark); } .shift-N { background-color: var(--shift-n-bg); color: var(--shift-text-light); } .shift-L { background-color: var(--shift-l-bg); color: var(--shift-text-dark); }
        body.light-mode .shift-L, body.light-mode .shift-T { color: var(--shift-text-dark); } body.light-mode .shift-N { color: var(--shift-text-light); }

        /* --- Resumen de Turnos del Mes --- */
        #shiftSummary { margin-top: 1rem; padding: 0.5rem 0.75rem; background-color: var(--shift-selector-bg); border-radius: 0.375rem; border: 1px solid var(--border-color); text-align: center; font-size: 0.8rem; color: var(--text-medium-color); max-width: 42rem; margin-left: auto; margin-right: auto; }
        #shiftSummary strong { color: var(--text-color); font-weight: 600; }
        #shiftSummary span { margin: 0 0.5rem; font-weight: 600; color: var(--summary-text-color); background-color: transparent; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3); }
        body.light-mode #shiftSummary span { text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.1); } body.light-mode #shiftSummary strong { color: var(--text-color); }

        /* --- Selector de Turnos (Responsivo) --- */
        #shiftSelector { background-color: var(--shift-selector-bg); padding: 0.75rem; border-radius: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; margin-top: 1.5rem; max-width: 42rem; margin-left: auto; margin-right: auto; border: 1px solid var(--border-color); align-items: center; }
        #shiftSelector .shift-label { font-size: 0.875rem; font-weight: 500; color: var(--text-color); margin-right: 0.5rem; flex-shrink: 0; text-align: center; width: 100%; margin-bottom: 0.5rem; } @media (min-width: 640px) { #shiftSelector { justify-content: flex-start; } #shiftSelector .shift-label { width: auto; margin-bottom: 0; } }
        .shift-button { padding: 0.4rem 0.6rem; border: 2px solid var(--shift-button-border); border-radius: 0.375rem; cursor: pointer; font-size: 0.8rem; font-weight: 500; transition: border-color 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease; min-width: auto; text-align: center; color: var(--text-color); flex-grow: 1; flex-basis: 60px; } @media (min-width: 640px) { .shift-button { padding: 0.5rem 0.75rem; font-size: 0.875rem; flex-grow: 0; } }
        .shift-button.active { border-color: var(--shift-button-active-border); box-shadow: 0 0 0 2px var(--shift-button-active-border); } .shift-button:hover:not(.active) { border-color: var(--text-medium-color); background-color: var(--button-hover-bg); }
        .shift-button.erase { background-color: var(--cancel-button-bg); color: var(--cancel-button-text); border-color: transparent; } .shift-button.erase:hover { filter: brightness(0.85); }
        .shift-button .icon { margin-right: 0.25rem; } .shift-button .text { display: none; } @media (min-width: 400px) { .shift-button .text { display: inline; } .shift-button .icon { margin-right: 0.3rem; } }

        /* --- Controles de Patrón (Responsivo) --- */
        .selecting-pattern .day-cell:not(.other-month):not(.week-number-cell) { box-shadow: inset 0 0 0 2px var(--pattern-select-bg); } /* .pattern-start-date, .pattern-end-date { background-color: var(--pattern-select-bg) !important; color: var(--pattern-select-text) !important; } */ /* Highlight number instead */
        #patternControls { background-color: var(--pattern-controls-bg); padding: 0.75rem; border-radius: 0.5rem; margin-top: 1rem; display: flex; flex-direction: column; gap: 0.75rem; align-items: center; max-width: 42rem; margin-left: auto; margin-right: auto; border: 1px solid var(--border-color); }
        #patternSelectionArea { display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center; justify-content: center; width: 100%; } #patternSelectionArea .pattern-label { font-size: 0.875rem; font-weight: 500; color: var(--text-color); margin-right: 0.5rem; flex-shrink: 0; width: 100%; text-align: center; margin-bottom: 0.5rem; } @media (min-width: 640px) { #patternSelectionArea { justify-content: flex-start; } #patternSelectionArea .pattern-label { width: auto; margin-bottom: 0; } }
        #patternControls.pattern-selecting-active #patternSelectionArea { flex-direction: column; gap: 0.5rem; } #patternControls.pattern-selecting-active #patternInfo { font-weight: 600; font-size: 0.9rem; padding: 0.5rem 0.75rem; background-color: var(--pattern-info-bg, transparent); border: 1px dashed var(--calendar-border); border-radius: 0.375rem; margin-top: 0.25rem; color: var(--calendar-text); width: auto; max-width: 90%; text-align: center; display: block !important; flex-grow: 0; } #patternControls.pattern-selecting-active #patternSelectionArea > span:first-of-type { display: none; }
        #patternInfo { font-size: 0.875rem; color: var(--text-medium-color); text-align: center; width: 100%; flex-grow: 1; display: inline-block; } #patternApplyArea { display: flex; flex-direction: column; gap: 0.75rem; align-items: center; justify-content: center; width: 100%; }
        #selectedPatternDisplay { font-size: 0.8rem; color: var(--text-medium-color); background-color: var(--pattern-display-bg); padding: 0.3rem 0.6rem; border-radius: 0.25rem; word-break: break-all; text-align: center; width: 100%; max-width: 300px; margin: 0 auto; min-height: 1.5rem; border: 1px solid var(--border-color); order: -1; }
        .pattern-apply-controls { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; align-items: center; width: 100%; } .pattern-apply-controls label { font-size: 0.8rem; font-weight: 500; white-space: nowrap; margin-right: 0.25rem; }
        #applyUntilDate { padding: 0.4rem 0.6rem; border: 1px solid var(--input-border); border-radius: 0.375rem; background-color: var(--input-bg); color: var(--input-text); font-size: 0.8rem; color-scheme: dark; flex-grow: 1; min-width: 120px; max-width: 150px; } body.light-mode #applyUntilDate { color-scheme: light; }
        .pattern-button, #applySelectedPatternBtn { padding: 0.4rem 0.8rem; border: none; border-radius: 0.375rem; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: opacity 0.2s ease, background-color 0.2s ease; flex-grow: 1; min-width: 80px; }
        #startPatternSelectionBtn { background-color: var(--pattern-select-bg); color: var(--pattern-select-text); } .pattern-button.cancel { background-color: var(--cancel-button-bg); color: var(--cancel-button-text); } .pattern-button.selecting { background-color: var(--cancel-button-bg); color: var(--cancel-button-text); } .pattern-button:hover { opacity: 0.85; }
        #applySelectedPatternBtn { background-color: var(--apply-button-bg); color: var(--apply-button-text); } #applySelectedPatternBtn:hover:not(:disabled) { filter: brightness(1.1); } #applySelectedPatternBtn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(50%); }
        @media (min-width: 640px) { #patternApplyArea { flex-direction: row; justify-content: space-between; } #selectedPatternDisplay { order: 0; margin: 0; width: auto; max-width: none; } .pattern-apply-controls { width: auto; justify-content: flex-end; } .pattern-apply-controls label { font-size: 0.875rem; } #applyUntilDate { font-size: 0.875rem; flex-grow: 0; max-width: none; } .pattern-button, #applySelectedPatternBtn { font-size: 0.875rem; padding: 0.5rem 1rem; flex-grow: 0; min-width: auto; } }

        /* --- Pie de página --- */
        .footer-notes { margin-top: 1.5rem; text-align: center; max-width: 42rem; margin-left: auto; margin-right: auto; } .footer-notes p { font-size: 0.875rem; color: var(--text-medium-color); margin: 0; }

        /* --- Guía (Popup Simple) --- */
        #tutorialOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--tutorial-overlay-bg); display: none; justify-content: center; align-items: center; z-index: 1000; }
        #tutorialModal { background-color: var(--tutorial-modal-bg); color: var(--tutorial-modal-text); padding: 1.5rem 2rem; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.2); max-width: 95%; width: 550px; z-index: 1001; border: 1px solid var(--border-color); position: relative; max-height: 80vh; overflow-y: auto; }
        #tutorialModal h3 { font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; text-align: center; color: var(--text-color); } #tutorialModal p, #tutorialModal ul { font-size: 0.95rem; margin-bottom: 1rem; line-height: 1.6; color: var(--text-color); } #tutorialModal ul { list-style: disc; padding-left: 1.5rem; } #tutorialModal li { margin-bottom: 0.5rem; } #tutorialModal strong { font-weight: 600; color: var(--accent-color); }
        #tutorialModal .tutorial-nav { display: flex; justify-content: flex-end; margin-top: 1.5rem; } .tutorial-button { padding: 0.6rem 1.2rem; border: none; border-radius: 0.375rem; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s ease; } .tutorial-button.primary { background-color: var(--button-primary-bg); color: var(--button-primary-text); } .tutorial-button.primary:hover { background-color: var(--button-primary-hover-bg); filter: brightness(1.1); }

        /* --- Tooltip Personalizado --- */
        #customTooltip { position: absolute; display: none; background-color: var(--tooltip-bg); color: var(--tooltip-text); border: 1px solid var(--border-color); border-radius: 0.375rem; padding: 0.5rem 0.75rem; font-size: 0.85rem; max-width: 250px; word-wrap: break-word; z-index: 1200; pointer-events: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* --- Modal Detalles Día --- */
        #dayDetailModalOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-overlay-bg); display: none; justify-content: center; align-items: center; z-index: 1050; }
        #dayDetailModal { background-color: var(--modal-bg); color: var(--text-color); padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.3); max-width: 90%; width: 450px; z-index: 1051; border: 1px solid var(--modal-border); position: relative; max-height: 85vh; display: flex; flex-direction: column; }
        #dayDetailModal h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; text-align: center; color: var(--text-color); border-bottom: 1px solid var(--border-color); padding-bottom: 0.75rem; }
        #dayDetailModal .modal-content { overflow-y: auto; padding-right: 0.5rem; margin-bottom: 1rem; flex-grow: 1; }
        #dayDetailModal label { display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500; color: var(--text-medium-color); }
        #dayDetailModal textarea, #dayDetailModal input[type="text"] { width: 100%; background-color: var(--input-bg); color: var(--input-text); border: 1px solid var(--input-border); border-radius: 0.375rem; padding: 0.5rem 0.75rem; font-size: 0.9rem; margin-bottom: 1rem; resize: vertical; }
        #dayDetailModal textarea:focus, #dayDetailModal input[type="text"]:focus { outline: none; border-color: var(--input-focus-border); box-shadow: 0 0 0 2px var(--input-focus-border); }
        #dayDetailModal textarea { min-height: 80px; }
        #dayDetailModal .checkbox-container { display: flex; align-items: center; margin-bottom: 1rem; }
        #dayDetailModal input[type="checkbox"] { appearance: none; width: 1rem; height: 1rem; border-radius: 0.25rem; border: 1px solid var(--input-border); background-color: var(--input-bg); margin-right: 0.5rem; cursor: pointer; position: relative; display: inline-block; vertical-align: middle; transition: background-color 0.2s ease, border-color 0.2s ease; background-repeat: no-repeat; background-position: center; background-size: 70%; }
        #dayDetailModal input[type="checkbox"]:checked { background-color: var(--checkbox-accent); border-color: var(--checkbox-accent); background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%230a0a0a'%3e%3cpath d='M12.207 4.793a1 1 0 0 1 0 1.414l-5 5a1 1 0 0 1-1.414 0l-2-2a1 1 0 0 1 1.414-1.414L6.5 9.086l4.293-4.293a1 1 0 0 1 1.414 0z'/%3e%3c/svg%3e"); }
        body.light-mode #dayDetailModal input[type="checkbox"]:checked { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23ffffff'%3e%3cpath d='M12.207 4.793a1 1 0 0 1 0 1.414l-5 5a1 1 0 0 1-1.414 0l-2-2a1 1 0 0 1 1.414-1.414L6.5 9.086l4.293-4.293a1 1 0 0 1 1.414 0z'/%3e%3c/svg%3e"); }
        #dayDetailModal .modal-actions { display: flex; justify-content: flex-end; gap: 0.75rem; border-top: 1px solid var(--border-color); padding-top: 1rem; }
        .modal-button { padding: 0.5rem 1rem; border: none; border-radius: 0.375rem; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s ease, filter 0.2s ease; }
        .modal-button.primary { background-color: var(--button-primary-bg); color: var(--button-primary-text); } .modal-button.primary:hover { filter: brightness(1.1); }
        .modal-button.secondary { background-color: var(--button-secondary-bg); color: var(--button-secondary-text); } .modal-button.secondary:hover { background-color: var(--button-secondary-hover-bg); }

    </style>
</head>
<body class="">
    <div class="main-container">

        <h1 class="main-title">Calendario GUARD-IA</h1>
        <div id="mainCalendarArea"> <div class="calendar-container">
                <div class="calendar-nav"> <button id="prevMonth" aria-label="Mes anterior" class="nav-button"><i class="fas fa-chevron-left"></i></button> <button id="goToTodayBtn" aria-label="Ir a Hoy" class="nav-button" title="Ir al mes actual">Hoy</button> <h2 id="currentMonthYear" class=""></h2> <button id="nextMonth" aria-label="Mes siguiente" class="nav-button"><i class="fas fa-chevron-right"></i></button> </div>
                <div> <div id="calendarGridHeader" class="calendar-grid-header"> </div> <div id="calendarGrid" class="calendar-grid"> </div> </div>
            </div>
             <div id="shiftSummary" style="display: none;"></div>
            <div id="editControlsWrapper" class="mt-4" style="display: none;"> <div id="shiftSelector"> <span class="shift-label">Asignar Turno:</span> <button class="shift-button erase" data-shift-type="erase" title="Borrar turno"> <i class="fas fa-eraser icon"></i> <span class="text">Borrar</span> </button> </div> <div id="patternControls" class="mt-4"> <div id="patternSelectionArea"> <span class="pattern-label">Repetir Patrón:</span> <button id="startPatternSelectionBtn" class="pattern-button">Seleccionar Patrón</button> <span id="patternInfo"></span> </div> <div id="patternApplyArea" class="hidden mt-2"> <div id="selectedPatternDisplay"></div> <div class="pattern-apply-controls"> <label for="applyUntilDate">Extender hasta:</label> <input type="date" id="applyUntilDate" class="text-sm"> <button id="applySelectedPatternBtn" class="apply-button" disabled>Aplicar</button> <button id="cancelPatternSelectionBtn" class="pattern-button cancel">Cancelar</button> </div> </div> </div> </div>
        </div>

        <div class="footer-notes" style="display: none;"> <p>(Selecciona o crea un calendario para empezar)</p> </div>

    </div> <div id="bottomBar">
        <div class="bottom-bar-content">
            <div id="bottomActions">
                <button id="editShiftsBtnBottom" class="bottom-action-button" title="Editar Turnos/Patrón" disabled> <i class="fas fa-edit fa-fw"></i> <span>Editar</span> </button>
                <button id="startTutorialBtnBottom" class="bottom-action-button" title="Iniciar guía interactiva"> <i class="fas fa-question-circle fa-fw"></i> <span>Guía</span> </button>
                <button id="themeToggleBtnBottom" class="bottom-action-button" title="Cambiar tema"> </button>
                <button id="menuToggleBtnBottom" aria-label="Abrir menú"> <i class="fas fa-cog"></i> </button>
            </div>
        </div>
    </div>

    <div id="mobileMenu" class="">
        <button id="closeMenuBtn" class="close-btn" aria-label="Cerrar menú">&times;</button>

        <a href="https://onefrai.github.io/guard-ia-app/" class="menu-link" id="homeBtnMobile"> <i class="fas fa-home fa-fw"></i> Home </a>
        <button class="menu-item" id="startTutorialBtnMobile"> <i class="fas fa-question-circle fa-fw"></i> Guía Rápida </button>
        <button class="menu-item theme-toggle-mobile" id="themeToggleBtnMobile"> </button>
        <button class="menu-item" id="editShiftsBtnMobile" disabled> <i class="fas fa-edit fa-fw"></i> Editar Turnos/Patrón </button>

        <div class="menu-section">
            <div class="menu-section-title">Gestión Calendario</div>
            <div class="menu-calendar-management">
                <label for="calendarSelectorMobile">Calendario Activo:</label>
                <select id="calendarSelectorMobile"></select>
                <label for="newCalendarNameMobile" class="mt-2">Nuevo Calendario:</label>
                <input type="text" id="newCalendarNameMobile" placeholder="Nombre...">
                <div class="add-delete-buttons">
                    <button id="addCalendarBtnMobile" class="management-button-menu"> <i class="fas fa-plus"></i> Añadir </button>
                    <button id="deleteCalendarBtnMobile" class="management-button-menu" disabled> <i class="fas fa-trash-alt"></i> Eliminar </button>
                </div>
            </div>
        </div>

        <div class="menu-section">
             <div class="menu-section-title">Copia Seguridad</div>
             <button class="menu-item" id="exportBtnMobile" disabled> <i class="fas fa-file-export fa-fw"></i> Exportar Actual </button>
             <button class="menu-item" id="importBtnMobile"> <i class="fas fa-file-import fa-fw"></i> Importar Nuevo </button>
             <input type="file" id="importFile" accept=".json" style="display: none;"> </div>
    </div>

    <div id="menuOverlay"></div>


    <div id="tutorialOverlay"> <div id="tutorialModal"> <h3 id="tutorialTitle">Guía Rápida</h3> <div id="tutorialContent"> <p>¡Bienvenido al Gestor de Calendarios GUARD-IA!</p> <ul> <li><strong>Gestión Calendario:</strong> Abre el menú (<i class="fas fa-cog"></i>) para seleccionar, añadir o eliminar calendarios.</li> <li><strong>Copia Seguridad:</strong> En el menú (<i class="fas fa-cog"></i>) puedes Exportar el actual o Importar uno nuevo (JSON).</li> <li><strong>Navegar Mes:</strong> Usa <i class="fas fa-chevron-left"></i> <i class="fas fa-chevron-right"></i> o <strong>Hoy</strong>.</li> <li><strong>Editar Turnos/Patrón:</strong> Pulsa <strong><i class="fas fa-edit"></i> Editar</strong> (barra inferior / menú <i class="fas fa-cog"></i>) para mostrar/ocultar controles.</li> <li><strong>Asignar Turno:</strong> Con controles visibles, selecciona turno y haz clic en días.</li> <li><strong>Ver/Editar Detalles Día:</strong> Haz <strong>clic simple</strong> en un día (con controles <strong>ocultos</strong>) para abrir la ventana de detalles.</li> <li><strong>Marcar Evento:</strong> Haz <strong>doble clic</strong> en un día O usa la ventana de detalles.</li> <li><strong>Repetir Patrón:</strong> Con controles visibles...</li> <li><strong>Guía y Tema:</strong> Botones en barra inferior / menú <i class="fas fa-cog"></i>.</li> </ul> </div> <div class="tutorial-nav"> <button id="tutorialCloseBtn" class="tutorial-button primary">Entendido</button> </div> </div> </div>
    <div id="customTooltip"></div>
    <div id="dayDetailModalOverlay"> <div id="dayDetailModal"> <h3 id="dayDetailModalTitle">Detalles del Día</h3> <div class="modal-content"> <input type="hidden" id="dayDetailEditingDate"> <label for="dayDetailNote">Notas:</label> <textarea id="dayDetailNote" rows="4" placeholder="Añade tus notas aquí..."></textarea> <label for="dayDetailExtraInfo">Información Extra:</label> <input type="text" id="dayDetailExtraInfo" placeholder="Ej: Horas, pago..."> <div class="checkbox-container"> <input type="checkbox" id="dayDetailEvent"> <label for="dayDetailEvent" class="ml-2 cursor-pointer">Marcar como Evento Especial (<i class="fas fa-star" style="color: var(--event-indicator-color)"></i>)</label> </div> </div> <div class="modal-actions"> <button id="dayDetailCancelBtn" class="modal-button secondary">Cancelar</button> <button id="dayDetailSaveBtn" class="modal-button primary">Guardar</button> </div> </div> </div>


    <script>
        // --- Constants and Global Variables ---
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        // UI Elements
        const calendarGridHeader = document.getElementById('calendarGridHeader'); const calendarGrid = document.getElementById('calendarGrid'); const currentMonthYearElement = document.getElementById('currentMonthYear');
        const prevMonthButton = document.getElementById('prevMonth'); const nextMonthButton = document.getElementById('nextMonth'); const goToTodayBtn = document.getElementById('goToTodayBtn');
        const shiftSelectorContainer = document.getElementById('shiftSelector'); const patternControlsContainer = document.getElementById('patternControls'); const applyUntilDateInput = document.getElementById('applyUntilDate');
        const applySelectedPatternBtn = document.getElementById('applySelectedPatternBtn'); const startPatternSelectionBtn = document.getElementById('startPatternSelectionBtn'); const patternSelectionArea = document.getElementById('patternSelectionArea');
        const patternApplyArea = document.getElementById('patternApplyArea'); const patternInfo = document.getElementById('patternInfo'); const selectedPatternDisplay = document.getElementById('selectedPatternDisplay');
        const cancelPatternSelectionBtn = document.getElementById('cancelPatternSelectionBtn');
        // Calendar Management (Mobile Menu)
        const calendarSelectorMobile = document.getElementById('calendarSelectorMobile');
        const newCalendarNameInputMobile = document.getElementById('newCalendarNameMobile');
        const addCalendarBtnMobile = document.getElementById('addCalendarBtnMobile');
        const deleteCalendarBtnMobile = document.getElementById('deleteCalendarBtnMobile');
        // Export/Import (Mobile Menu)
        const exportBtnMobile = document.getElementById('exportBtnMobile');
        const importBtnMobile = document.getElementById('importBtnMobile');
        const importFileInput = document.getElementById('importFile');
        // ---
        const mainCalendarArea = document.getElementById('mainCalendarArea'); const footerStatusText = document.querySelector('.footer-notes p');
        // Menu (Bottom)
        const menuToggleBtnBottom = document.getElementById('menuToggleBtnBottom');
        const mobileMenu = document.getElementById('mobileMenu'); const closeMenuBtn = document.getElementById('closeMenuBtn');
        const menuOverlay = document.getElementById('menuOverlay');
        // Actions (Bottom Bar - Desktop)
        const editShiftsBtnBottom = document.getElementById('editShiftsBtnBottom');
        const startTutorialBtnBottom = document.getElementById('startTutorialBtnBottom');
        const themeToggleBtnBottom = document.getElementById('themeToggleBtnBottom');
        // Actions (Mobile Menu)
        const editShiftsBtnMobile = document.getElementById('editShiftsBtnMobile');
        const startTutorialBtnMobile = document.getElementById('startTutorialBtnMobile');
        const themeToggleBtnMobile = document.getElementById('themeToggleBtnMobile');
        // ---
        const tutorialOverlay = document.getElementById('tutorialOverlay'); const tutorialModal = document.getElementById('tutorialModal'); const tutorialCloseBtn = document.getElementById('tutorialCloseBtn');
        const editControlsWrapper = document.getElementById('editControlsWrapper');
        const shiftSummaryElement = document.getElementById('shiftSummary'); const customTooltipElement = document.getElementById('customTooltip');
        // Day Detail Modal elements
        const dayDetailModalOverlay = document.getElementById('dayDetailModalOverlay'); const dayDetailModal = document.getElementById('dayDetailModal'); const dayDetailModalTitle = document.getElementById('dayDetailModalTitle');
        const dayDetailEditingDateInput = document.getElementById('dayDetailEditingDate'); const dayDetailNoteTextarea = document.getElementById('dayDetailNote');
        const dayDetailExtraInfoInput = document.getElementById('dayDetailExtraInfo'); const dayDetailEventCheckbox = document.getElementById('dayDetailEvent');
        const dayDetailSaveBtn = document.getElementById('dayDetailSaveBtn'); const dayDetailCancelBtn = document.getElementById('dayDetailCancelBtn');

        // Application Data
        let currentDate = new Date(); let selectedShiftType = null; let calendarsData = {};
        let calendarList = []; let activeCalendarName = null; let isSelectingPattern = false;
        let patternStartDate = null; let patternEndDate = null; let selectedPatternSequence = [];
        let firstTimeUser = false; // Flag for first time hints

        // Shift Type Configuration
        const shiftTypes = { 'M': { label: 'Mañana', colorClass: 'shift-M', icon: 'fa-sun' }, 'T': { label: 'Tarde', colorClass: 'shift-T', icon: 'fa-cloud-sun' }, 'N': { label: 'Noche', colorClass: 'shift-N', icon: 'fa-moon' }, 'L': { label: 'Libre', colorClass: 'shift-L', icon: 'fa-bed' }, };
        const defaultShiftForPattern = undefined;

        // LocalStorage Keys
        const CALENDARS_DATA_KEY = 'multiCalendarAppData_v5.3'; // Version bump for fixes
        const ACTIVE_CALENDAR_KEY = 'multiCalendarActiveCal';
        const TUTORIAL_COMPLETED_KEY = 'multiCalendarTutorialCompleted_v5.3';
        const THEME_KEY = 'multiCalendarTheme';
        const APP_VERSION_KEY = 'multiCalendarAppVersion';

        // --- Theme Functions ---
        function applyTheme(theme) { /* ... no changes ... */ const isLight = theme === 'light'; document.body.classList.toggle('light-mode', isLight); document.body.classList.toggle('dark-mode', !isLight); const iconClass = isLight ? 'fa-moon' : 'fa-sun'; const text = isLight ? 'Oscuro' : 'Claro'; const title = isLight ? 'Cambiar a tema oscuro' : 'Cambiar a tema claro'; if (themeToggleBtnBottom) { themeToggleBtnBottom.innerHTML = `<i class="fas ${iconClass} fa-fw"></i> <span>${text}</span>`; themeToggleBtnBottom.title = title; } if (themeToggleBtnMobile) { themeToggleBtnMobile.innerHTML = `<i class="fas ${iconClass} fa-fw"></i> ${text}`; } localStorage.setItem(THEME_KEY, theme); console.log(`Theme applied: ${theme}`); updateCheckboxStyle(theme); }
        function updateCheckboxStyle(theme) { /* ... no changes ... */ const isLight = theme === 'light'; const checkmarkColor = isLight ? 'ffffff' : '0a0a0a'; const svgUrl = `url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23${checkmarkColor}'%3e%3cpath d='M12.207 4.793a1 1 0 0 1 0 1.414l-5 5a1 1 0 0 1-1.414 0l-2-2a1 1 0 0 1 1.414-1.414L6.5 9.086l4.293-4.293a1 1 0 0 1 1.414 0z'/%3e%3c/svg%3e")`; console.log("Checkbox SVG URL for " + theme + ": " + svgUrl); }
        function toggleTheme() { /* ... no changes ... */ const currentTheme = document.body.classList.contains('dark-mode') ? 'dark' : 'light'; applyTheme(currentTheme === 'dark' ? 'light' : 'dark'); closeMobileMenu(); }
        function loadInitialTheme() { /* ... no changes ... */ applyTheme(localStorage.getItem(THEME_KEY) || 'dark'); }

        // --- Mobile Menu Functions ---
        function openMobileMenu() {
            if (mobileMenu) mobileMenu.classList.add('open');
            if (menuOverlay) menuOverlay.style.display = 'block';
            if (firstTimeUser && calendarList.length === 0 && newCalendarNameInputMobile) {
                newCalendarNameInputMobile.classList.add('highlight-input');
                newCalendarNameInputMobile.addEventListener('input', () => {
                    newCalendarNameInputMobile.classList.remove('highlight-input');
                }, { once: true });
            }
            if (menuToggleBtnBottom.classList.contains('pulsate-glow')) {
                 menuToggleBtnBottom.classList.remove('pulsate-glow');
            }
        }
        function closeMobileMenu() {
            if (mobileMenu) mobileMenu.classList.remove('open');
            if (menuOverlay) menuOverlay.style.display = 'none';
        }

        // --- Tutorial Popup Functions ---
        function showTutorialPopup() { console.log("Showing tutorial popup..."); tutorialOverlay.style.display = 'flex'; closeMobileMenu(); }
        function hideTutorialPopup(markAsCompleted = true) { console.log("Hiding tutorial popup..."); tutorialOverlay.style.display = 'none'; if (markAsCompleted) { localStorage.setItem(TUTORIAL_COMPLETED_KEY, 'true'); firstTimeUser = false; } }

        // --- Data and LocalStorage Functions ---
        function loadData() { /* ... no changes ... */ const storedData = localStorage.getItem(CALENDARS_DATA_KEY); try { calendarsData = storedData ? JSON.parse(storedData) : {}; if (typeof calendarsData !== 'object' || calendarsData === null || Array.isArray(calendarsData)) { console.warn("Invalid calendar data found in localStorage, resetting."); calendarsData = {}; } } catch (error) { console.error("Error parsing calendar data from localStorage, resetting:", error); calendarsData = {}; } calendarList = Object.keys(calendarsData); activeCalendarName = localStorage.getItem(ACTIVE_CALENDAR_KEY); if (!activeCalendarName || !calendarsData[activeCalendarName]) { activeCalendarName = calendarList.length > 0 ? calendarList[0] : null; if (activeCalendarName) { localStorage.setItem(ACTIVE_CALENDAR_KEY, activeCalendarName); } else { localStorage.removeItem(ACTIVE_CALENDAR_KEY); } } console.log("Data loaded (v5.3):", { calendarsData, calendarList, activeCalendarName }); }
        function saveData() { /* ... no changes ... */ try { localStorage.setItem(CALENDARS_DATA_KEY, JSON.stringify(calendarsData)); if (activeCalendarName) { localStorage.setItem(ACTIVE_CALENDAR_KEY, activeCalendarName); } else { localStorage.removeItem(ACTIVE_CALENDAR_KEY); } console.log("Data saved (v5.3)."); } catch (error) { console.error("Error saving data to localStorage:", error); } }

        // --- Date Helper Functions ---
        function formatDate(date) { /* ... no changes ... */ if (!(date instanceof Date) || isNaN(date)) { console.error("Invalid date passed to formatDate:", date); return ""; } const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0'); const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`; }
        function parseDateString(dateString) { /* ... no changes ... */ if (!dateString || typeof dateString !== 'string' || !/^\d{4}-\d{2}-\d{2}$/.test(dateString)) { console.error("Invalid date string passed to parseDateString:", dateString); return null; } const date = new Date(dateString + 'T12:00:00Z'); if (isNaN(date.getTime())) { console.error("Could not parse date string:", dateString); return null; } return date; }
        function getWeekNumber(d) { /* ... no changes ... */ d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7)); var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1)); var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7); return weekNo; }
        function getCurrentWeekNumber(today = new Date()) { /* ... no changes ... */ let thursday = new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate())); thursday.setUTCDate(thursday.getUTCDate() + 4 - (thursday.getUTCDay() || 7)); return getWeekNumber(thursday); }

        // --- Calendar Management UI Functions (Now using Mobile Menu elements) ---
        function updateCalendarSelector() { /* ... no changes ... */ const selector = calendarSelectorMobile; selector.innerHTML = ''; const noCalendars = calendarList.length === 0; if (noCalendars) { const o = document.createElement('option'); o.value = ""; o.textContent = "Crea calendario"; o.disabled = true; selector.appendChild(o); selector.disabled = true; deleteCalendarBtnMobile.disabled = true; exportBtnMobile.disabled = true; } else { selector.disabled = false; deleteCalendarBtnMobile.disabled = false; exportBtnMobile.disabled = false; calendarList.forEach(name => { const o = document.createElement('option'); o.value = name; o.textContent = name; if (name === activeCalendarName) o.selected = true; selector.appendChild(o); }); } updateEditButtonsState(); }
        function addCalendar() { /* ... no changes ... */ const input = newCalendarNameInputMobile; const name = input.value.trim(); if (!name) { alert("Por favor, introduce un nombre para el nuevo calendario."); return; } if (calendarsData[name]) { alert(`El calendario "${name}" ya existe. Elige otro nombre.`); return; } console.log(`Adding calendar: ${name}`); calendarsData[name] = {}; calendarList.push(name); calendarList.sort(); activeCalendarName = name; updateCalendarSelector(); input.value = ''; input.classList.remove('highlight-input'); showMainCalendarArea(true); renderCalendar(currentDate.getFullYear(), currentDate.getMonth()); saveData(); if (editControlsWrapper) editControlsWrapper.style.display = 'none'; if (isSelectingPattern) cancelPatternSelection(true); closeMobileMenu(); }
        function selectCalendar() { /* ... no changes ... */ const selector = calendarSelectorMobile; const name = selector.value; if (name && calendarsData[name]) { activeCalendarName = name; console.log(`Active calendar changed to: ${activeCalendarName}`); localStorage.setItem(ACTIVE_CALENDAR_KEY, activeCalendarName); renderCalendar(currentDate.getFullYear(), currentDate.getMonth()); if (isSelectingPattern) cancelPatternSelection(true); showMainCalendarArea(true); if (editControlsWrapper) editControlsWrapper.style.display = 'none'; updateEditButtonsState(); closeMobileMenu(); } else { console.warn("Invalid calendar selected:", name); } }
        function deleteCalendar() { /* ... no changes ... */ const selector = calendarSelectorMobile; const calendarNameToDelete = selector.value; if (!calendarNameToDelete || !calendarsData[calendarNameToDelete]) { alert("No hay un calendario seleccionado para eliminar."); return; } if (confirm(`¿Estás seguro de que quieres eliminar el calendario "${calendarNameToDelete}"?\n\n¡Esta acción no se puede deshacer!`)) { console.log(`Deleting calendar: ${calendarNameToDelete}`); delete calendarsData[calendarNameToDelete]; calendarList = calendarList.filter(name => name !== calendarNameToDelete); if (activeCalendarName === calendarNameToDelete) { activeCalendarName = calendarList.length > 0 ? calendarList[0] : null; if (activeCalendarName) { localStorage.setItem(ACTIVE_CALENDAR_KEY, activeCalendarName); } else { localStorage.removeItem(ACTIVE_CALENDAR_KEY); } } updateCalendarSelector(); if (activeCalendarName) { renderCalendar(currentDate.getFullYear(), currentDate.getMonth()); showMainCalendarArea(true); } else { calendarGrid.innerHTML = ''; calendarGridHeader.innerHTML = ''; currentMonthYearElement.textContent = ""; showMainCalendarArea(false); } saveData(); alert(`Calendario "${calendarNameToDelete}" eliminado.`); if (editControlsWrapper) editControlsWrapper.style.display = 'none'; if (isSelectingPattern) cancelPatternSelection(true); updateEditButtonsState(); } }
        function showMainCalendarArea(show) { /* ... no changes ... */ mainCalendarArea.style.display = show ? 'block' : 'none'; if (!show && editControlsWrapper) { editControlsWrapper.style.display = 'none'; } updateEditButtonsState(); }
        function updateEditButtonsState() { /* ... no changes ... */ const enable = !!activeCalendarName; if (editShiftsBtnBottom) editShiftsBtnBottom.disabled = !enable; if (editShiftsBtnMobile) editShiftsBtnMobile.disabled = !enable; if (exportBtnMobile) exportBtnMobile.disabled = !enable; }

        // --- Calendar Rendering Functions ---
        function renderCalendar(year, month) { /* ... no changes ... */ showMainCalendarArea(true); console.log(`Rendering calendar: ${activeCalendarName || 'No active calendar'} - ${monthNames[month]} ${year}`); const calendarData = activeCalendarName ? calendarsData[activeCalendarName] : {}; currentMonthYearElement.textContent = `${monthNames[month]} ${year}`; calendarGridHeader.innerHTML = ''; const bh = document.createElement('div'); bh.className = 'week-header'; bh.textContent = 'Sem'; calendarGridHeader.appendChild(bh); const dayHeaders = ['L', 'M', 'M', 'J', 'V', 'S', 'D']; dayHeaders.forEach(d => { const h = document.createElement('div'); h.textContent = d; calendarGridHeader.appendChild(h); }); calendarGrid.innerHTML = ''; const firstDayOfMonth = new Date(year, month, 1); let dayOfWeekForFirst = firstDayOfMonth.getDay(); let mondayBasedDayOfWeek = (dayOfWeekForFirst === 0) ? 6 : dayOfWeekForFirst - 1; let currentMonday = new Date(firstDayOfMonth); currentMonday.setDate(firstDayOfMonth.getDate() - mondayBasedDayOfWeek); const today = new Date(); const todayString = formatDate(today); const todayWeekNumber = getCurrentWeekNumber(today); const totalWeeks = 6; let monthlyShiftCounts = { M: 0, T: 0, N: 0, L: 0 }; for (let week = 0; week < totalWeeks; week++) { let thursdayOfWeek = new Date(currentMonday); thursdayOfWeek.setDate(currentMonday.getDate() + 3); const currentRenderWeekNumber = getWeekNumber(thursdayOfWeek); const isCurrentDisplayWeek = (currentRenderWeekNumber === todayWeekNumber && today.getFullYear() === year); const weekNumberCell = document.createElement('div'); weekNumberCell.className = 'day-cell week-number-cell'; weekNumberCell.textContent = currentRenderWeekNumber; if (isCurrentDisplayWeek) weekNumberCell.classList.add('current-week-row'); calendarGrid.appendChild(weekNumberCell); for (let dayIndex = 0; dayIndex < 7; dayIndex++) { const cellDate = new Date(currentMonday); cellDate.setDate(currentMonday.getDate() + dayIndex); const cellDateString = formatDate(cellDate); const cell = document.createElement('div'); cell.classList.add('day-cell'); cell.dataset.date = cellDateString; const dayNumberSpan = document.createElement('span'); dayNumberSpan.classList.add('day-number'); dayNumberSpan.textContent = cellDate.getDate(); const isCurrentMonth = cellDate.getMonth() === month; if (!isCurrentMonth) cell.classList.add('other-month'); else if (cellDateString === todayString) cell.classList.add('current-day'); if (isCurrentDisplayWeek) cell.classList.add('current-week-row'); if (activeCalendarName && (isCurrentMonth || isSelectingPattern)) { cell.classList.add('cursor-pointer'); cell.removeEventListener('click', handleDayClickWrapper); cell.removeEventListener('dblclick', handleDayDoubleClickWrapper); cell.removeEventListener('mouseover', handleMouseOverWrapper); cell.removeEventListener('mouseout', handleMouseOutWrapper); cell.addEventListener('click', handleDayClickWrapper); cell.addEventListener('dblclick', handleDayDoubleClickWrapper); const dayData = calendarData[cellDateString]; const noteText = dayData?.note || ''; const extraInfo = dayData?.extra || ''; if (noteText || extraInfo) { cell.addEventListener('mouseover', handleMouseOverWrapper); cell.addEventListener('mouseout', handleMouseOutWrapper); } } else { cell.classList.add('cursor-default'); } const contentDiv = document.createElement('div'); contentDiv.classList.add('day-cell-content'); const dayData = calendarData[cellDateString]; const noteText = dayData?.note || ''; const shiftType = dayData?.shift; const isEvent = dayData?.event || false; const extraInfo = dayData?.extra || ''; if (shiftType && shiftTypes[shiftType]) { const shiftIndicator = document.createElement('div'); shiftIndicator.classList.add('shift-indicator', shiftTypes[shiftType].colorClass); shiftIndicator.textContent = shiftType; contentDiv.appendChild(shiftIndicator); if (isCurrentMonth && monthlyShiftCounts.hasOwnProperty(shiftType)) { monthlyShiftCounts[shiftType]++; } } if (noteText) { const noteDiv = document.createElement('div'); noteDiv.className = 'note-text line-clamp-2'; noteDiv.textContent = noteText; contentDiv.appendChild(noteDiv); } cell.title = ''; if (isEvent) { const eventIndicator = document.createElement('i'); eventIndicator.className = 'fas fa-star event-indicator'; cell.appendChild(eventIndicator); } cell.appendChild(dayNumberSpan); cell.appendChild(contentDiv); calendarGrid.appendChild(cell); } currentMonday.setDate(currentMonday.getDate() + 7); } highlightPatternSelection(); checkApplyButtonState(); updateShiftSummary(monthlyShiftCounts); if (!activeCalendarName) { showMainCalendarArea(false); } }

        // --- Wrappers for Event Listeners ---
        function handleDayClickWrapper(event) { const cell = event.currentTarget; handleDayClick(cell.dataset.date, cell); }
        function handleDayDoubleClickWrapper(event) { const cell = event.currentTarget; handleDayDoubleClick(cell.dataset.date, cell); }
        function handleMouseOverWrapper(event) { const cell = event.currentTarget; if (!activeCalendarName) return; const dayData = calendarsData[activeCalendarName]?.[cell.dataset.date] || {}; const noteText = dayData.note || ''; const extraInfo = dayData.extra || ''; let tooltipText = ''; if (noteText) tooltipText += noteText; if (extraInfo) tooltipText += (tooltipText ? `\n---\nExtra: ${extraInfo}` : `Extra: ${extraInfo}`); if (tooltipText) showCustomTooltip(event, tooltipText); }
        function handleMouseOutWrapper(event) { hideCustomTooltip(); }

        // --- Cell Click and Data Management Functions ---
        function handleDayClick(dateString, cellElement) { /* ... no changes ... */ if (!activeCalendarName) { console.warn("Click ignored: No active calendar."); return; } if (cellElement.classList.contains('week-number-cell')) return; if (cellElement.classList.contains('other-month') && !isSelectingPattern) return; const controlsVisible = editControlsWrapper.style.display !== 'none'; if (isSelectingPattern) { handlePatternSelectionClick(dateString, cellElement); } else if (controlsVisible && selectedShiftType !== null) { applySingleShift(dateString); } else if (!cellElement.classList.contains('other-month')) { openDayDetailModal(dateString); } else { console.log("Click ignored (other month, not selecting pattern or applying shift)."); } }
        function handleDayDoubleClick(dateString, cellElement) { /* ... (Corrected safety check) ... */
            if (!activeCalendarName || cellElement.classList.contains('other-month')) return;
            console.log(`Double click on: ${dateString}`);
            if (!calendarsData[activeCalendarName]) { console.error(`Data for active calendar "${activeCalendarName}" not found.`); return; }
            const calendarData = calendarsData[activeCalendarName];
            if (!calendarData[dateString]) { calendarData[dateString] = {}; }
            calendarData[dateString].event = !calendarData[dateString].event;
            if (!calendarData[dateString].event) { delete calendarData[dateString].event; }
            console.log(`Event status for ${dateString}: ${calendarData[dateString]?.event ? 'Marcado' : 'Desmarcado'}`);
            if (!calendarData[dateString]?.shift && !calendarData[dateString]?.note && !calendarData[dateString]?.event && !calendarData[dateString]?.extra) {
                delete calendarData[dateString]; console.log(`Empty entry removed for ${dateString}`);
            }
            saveData();
            renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
        }
        function applySingleShift(dateString) { /* ... no changes ... */ if (!activeCalendarName || selectedShiftType === null) return; const calendarData = calendarsData[activeCalendarName]; if (!calendarData[dateString] && selectedShiftType !== 'erase') { calendarData[dateString] = {}; } if (selectedShiftType === 'erase') { if (calendarData[dateString]) { delete calendarData[dateString].shift; console.log(`Shift erased for ${dateString}`); } } else { calendarData[dateString].shift = selectedShiftType; console.log(`Shift '${selectedShiftType}' applied to ${dateString}`); } if (calendarData[dateString] && !calendarData[dateString].shift && !calendarData[dateString].note && !calendarData[dateString].event && !calendarData[dateString]?.extra) { delete calendarData[dateString]; console.log(`Empty entry removed for ${dateString}`); } saveData(); renderCalendar(currentDate.getFullYear(), currentDate.getMonth()); }

        // --- Shift Selector Button Functions ---
        function createShiftSelectorButtons() { /* ... no changes ... */ const eraseButton = shiftSelectorContainer.querySelector('.erase'); shiftSelectorContainer.querySelectorAll('.shift-button:not(.erase)').forEach(b => b.remove()); Object.keys(shiftTypes).forEach(key => { const t = shiftTypes[key]; const b = document.createElement('button'); b.className = `shift-button ${t.colorClass}`; b.dataset.shiftType = key; b.title = `Asignar: ${t.label}`; b.innerHTML = `<i class="fas ${t.icon} icon"></i> <span class="text">${t.label}</span>`; b.addEventListener('click', () => selectShift(key, b)); shiftSelectorContainer.insertBefore(b, eraseButton); }); eraseButton.removeEventListener('click', handleEraseClick); eraseButton.addEventListener('click', handleEraseClick); }
        function handleEraseClick() { /* ... no changes ... */ selectShift('erase', shiftSelectorContainer.querySelector('.erase')); }
        function selectShift(shiftKey, clickedButton) { /* ... no changes ... */ if (isSelectingPattern) cancelPatternSelection(true); if (selectedShiftType === shiftKey) { selectedShiftType = null; clickedButton.classList.remove('active'); console.log("Shift deselected."); } else { selectedShiftType = shiftKey; console.log("Shift selected:", selectedShiftType); shiftSelectorContainer.querySelectorAll('.shift-button').forEach(b => b.classList.remove('active')); clickedButton.classList.add('active'); } }

        // --- Pattern Selection and Application Functions ---
        function togglePatternSelectionMode() { /* ... no changes ... */ if (!activeCalendarName) { return; } if (isSelectingPattern) { cancelPatternSelection(true); } else { isSelectingPattern = true; patternStartDate = null; patternEndDate = null; selectedPatternSequence = []; updateSavedPatternDisplay(); checkApplyButtonState(); patternControlsContainer.classList.add('pattern-selecting-active'); patternInfo.textContent = 'CLIC DÍA INICIO PATRÓN...'; startPatternSelectionBtn.textContent = 'Cancelar'; startPatternSelectionBtn.classList.add('selecting'); calendarGrid.classList.add('selecting-pattern'); patternApplyArea.classList.add('hidden'); patternSelectionArea.classList.remove('hidden'); selectedShiftType = null; shiftSelectorContainer.querySelectorAll('.shift-button.active').forEach(b => b.classList.remove('active')); renderCalendar(currentDate.getFullYear(), currentDate.getMonth()); } }
        function handlePatternSelectionClick(dateString, cellElement) { /* ... (Corrected highlight logic) ... */
             if (!isSelectingPattern) return;
             let tempStartDate = patternStartDate; let tempEndDate = patternEndDate;
             clearPatternHighlight(false); // Clear previous range highlight but keep start/end markers

             if (!tempStartDate) { // First click (start date)
                 tempStartDate = dateString;
                 patternInfo.textContent = 'CLIC DÍA FIN PATRÓN.';
                 console.log("Pattern start selected:", tempStartDate);
                 patternStartDate = tempStartDate; patternEndDate = null;
             } else { // Second click (end date)
                 tempEndDate = dateString; console.log("Pattern end selected:", tempEndDate);
                 let start = parseDateString(tempStartDate); let end = parseDateString(tempEndDate);
                 if (!start || !end) { alert("Fechas de patrón inválidas."); cancelPatternSelection(true); return; }
                 if (start > end) { [start, end] = [end, start]; [tempStartDate, tempEndDate] = [tempEndDate, tempStartDate]; console.log("Start/End dates swapped."); }
                 patternStartDate = tempStartDate; patternEndDate = tempEndDate;
                 extractAndShowPattern();
                 if (selectedPatternSequence.length > 0 || patternStartDate) {
                     isSelectingPattern = false; patternControlsContainer.classList.remove('pattern-selecting-active'); calendarGrid.classList.remove('selecting-pattern'); startPatternSelectionBtn.textContent = 'Sel. Otro Patrón'; startPatternSelectionBtn.classList.remove('selecting'); patternInfo.textContent = '';
                     if (selectedPatternSequence.length > 0) { patternApplyArea.classList.remove('hidden'); patternSelectionArea.classList.add('hidden'); }
                     checkApplyButtonState();
                 } else { patternStartDate = null; patternEndDate = null; patternInfo.textContent = 'CLIC DÍA INICIO PATRÓN...'; }
             }
             highlightPatternSelection(); // Highlight start, end, and range
         }
        function extractAndShowPattern() { /* ... no changes ... */ if (!activeCalendarName || !patternStartDate || !patternEndDate) { console.error("Cannot extract pattern: Missing dates."); selectedPatternSequence = []; updateSavedPatternDisplay(); return; } let start = parseDateString(patternStartDate), end = parseDateString(patternEndDate); if (!start || !end) { alert("Fechas de patrón inválidas."); cancelPatternSelection(true); return; } const calendarData = calendarsData[activeCalendarName]; selectedPatternSequence = []; let iterDate = new Date(Date.UTC(start.getFullYear(), start.getMonth(), start.getDate())); let endDateUTC = new Date(Date.UTC(end.getFullYear(), end.getMonth(), end.getDate())); while (iterDate <= endDateUTC) { const dateStr = formatDate(new Date(iterDate)); selectedPatternSequence.push(calendarData[dateStr]?.shift); iterDate.setUTCDate(iterDate.getUTCDate() + 1); } console.log("Extracted pattern sequence:", selectedPatternSequence); const hasDefinedShift = selectedPatternSequence.some(shift => shift !== undefined && shift !== null); if (!hasDefinedShift) { alert("El patrón seleccionado está vacío (no hay turnos asignados en el rango elegido). Por favor, selecciona un rango con al menos un turno asignado o cancela."); selectedPatternSequence = []; updateSavedPatternDisplay(); return; } updateSavedPatternDisplay(); }
        function highlightPatternSelection() { /* ... (Corrected range highlighting) ... */
            clearPatternHighlight(false);
            if (!patternStartDate) return;
            const start = parseDateString(patternStartDate);
            const startCellNumber = calendarGrid.querySelector(`.day-cell[data-date="${patternStartDate}"] .day-number`);
            if (startCellNumber) startCellNumber.classList.add('pattern-start-date');

            if (patternEndDate) {
                 const end = parseDateString(patternEndDate);
                 const endCellNumber = calendarGrid.querySelector(`.day-cell[data-date="${patternEndDate}"] .day-number`);
                 if (endCellNumber) endCellNumber.classList.add('pattern-end-date');

                 if (start && end) {
                    // Ensure start date is before end date for iteration
                    let startDate = start <= end ? new Date(start) : new Date(end);
                    let endDate = start <= end ? new Date(end) : new Date(start);
                    let currentDateIter = new Date(startDate); // Iterate with local date

                    while (currentDateIter <= endDate) {
                        const dateStr = formatDate(currentDateIter);
                        const cell = calendarGrid.querySelector(`.day-cell[data-date="${dateStr}"]`);
                        // Add range class to all cells within the date range
                        if (cell) {
                             cell.classList.add('pattern-range');
                        }
                        currentDateIter.setDate(currentDateIter.getDate() + 1);
                    }
                 }
            }
        }
        function clearPatternHighlight(clearStartEnd = true) { /* ... no changes ... */ calendarGrid.querySelectorAll('.pattern-range').forEach(c => c.classList.remove('pattern-range')); if (clearStartEnd) { calendarGrid.querySelectorAll('.pattern-start-date, .pattern-end-date').forEach(n => n.classList.remove('pattern-start-date', 'pattern-end-date')); } }
        function applySelectedPattern() { /* ... no changes ... */ if (!activeCalendarName || !patternStartDate || !patternEndDate) { alert("Error: Fechas del patrón original no definidas."); return; } if (selectedPatternSequence.length === 0) { alert("No hay patrón seleccionado."); return; } const untilValue = applyUntilDateInput.value; if (!untilValue) { alert("Selecciona fecha 'Extender hasta'."); return; } const untilDate = parseDateString(untilValue); const patternEndOriginal = parseDateString(patternEndDate); if (!untilDate || !patternEndOriginal) { alert("Fechas inválidas."); return; } let repeatStart = new Date(Date.UTC(patternEndOriginal.getFullYear(), patternEndOriginal.getMonth(), patternEndOriginal.getDate())); repeatStart.setUTCDate(repeatStart.getUTCDate() + 1); let untilDateUTC = new Date(Date.UTC(untilDate.getFullYear(), untilDate.getMonth(), untilDate.getDate())); if (repeatStart > untilDateUTC) { alert("'Extender hasta' debe ser posterior al fin del patrón."); return; } const patternLen = selectedPatternSequence.length; let pIndex = 0; const calendarData = calendarsData[activeCalendarName]; const patternStr = selectedPatternSequence.map(s => s || '-').join('-'); if (!confirm(`Extender patrón TURNOS (${patternStr}) en "${activeCalendarName}" desde ${formatDate(new Date(repeatStart))} hasta ${formatDate(new Date(untilDateUTC))}?\n(Sobrescribirá turnos, NO notas ni eventos)`)) { return; } let currentApply = new Date(repeatStart); let daysAffected = 0; while (currentApply <= untilDateUTC) { const dateStr = formatDate(new Date(currentApply)); const shiftToApply = selectedPatternSequence[pIndex % patternLen]; if (!calendarData[dateStr] && shiftToApply && shiftTypes[shiftToApply]) { calendarData[dateStr] = {}; } if (calendarData[dateStr]) { if (shiftToApply && shiftTypes[shiftToApply]) { calendarData[dateStr].shift = shiftToApply; } else { delete calendarData[dateStr].shift; } if (!calendarData[dateString].shift && !calendarData[dateString].note && !calendarData[dateString].event && !calendarData[dateString]?.extra) { delete calendarData[dateStr]; } } currentApply.setUTCDate(currentApply.getUTCDate() + 1); pIndex++; daysAffected++; } console.log(`Pattern applied. ${daysAffected} days processed.`); saveData(); cancelPatternSelection(true); renderCalendar(currentDate.getFullYear(), currentDate.getMonth()); alert(`Patrón extendido hasta ${formatDate(new Date(untilDateUTC))}.`); }
        function cancelPatternSelection(clearSequenceAndDate = true) { /* ... (Ensure range highlight is cleared) ... */ const wasSelecting = isSelectingPattern; isSelectingPattern = false; patternStartDate = null; patternEndDate = null; if (clearSequenceAndDate) { selectedPatternSequence = []; updateSavedPatternDisplay(); applyUntilDateInput.value = ''; } patternControlsContainer.classList.remove('pattern-selecting-active'); startPatternSelectionBtn.textContent = 'Seleccionar Patrón'; startPatternSelectionBtn.classList.remove('selecting'); patternInfo.textContent = ''; calendarGrid.classList.remove('selecting-pattern'); clearPatternHighlight(true); // Clear start, end, and range highlights patternApplyArea.classList.add('hidden'); patternSelectionArea.classList.remove('hidden'); if (wasSelecting) { renderCalendar(currentDate.getFullYear(), currentDate.getMonth()); } checkApplyButtonState(); console.log("Pattern selection cancelled."); }
        function updateSavedPatternDisplay() { /* ... no changes ... */ if (selectedPatternSequence.length > 0) { const patternHtml = selectedPatternSequence.map(shiftKey => { if (!shiftKey) return `<span class="inline-block px-1.5 py-0.5 text-xs font-semibold rounded mr-1 border border-[var(--border-color)] text-[var(--text-medium-color)]" title="Sin Turno">-</span>`; const shiftInfo = shiftTypes[shiftKey]; if (shiftInfo) return `<span class="inline-block px-1.5 py-0.5 text-xs font-semibold rounded mr-1 ${shiftInfo.colorClass}" title="${shiftInfo.label}">${shiftKey}</span>`; return '?'; }).join(''); selectedPatternDisplay.innerHTML = `Patrón: ${patternHtml}`; } else { selectedPatternDisplay.innerHTML = ""; } }
        function checkApplyButtonState() { /* ... no changes ... */ applySelectedPatternBtn.disabled = !(selectedPatternSequence.length > 0 && applyUntilDateInput.value !== ''); }
        applyUntilDateInput.addEventListener('change', checkApplyButtonState);

        // --- Calendar Navigation & Summary ---
        prevMonthButton.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(currentDate.getFullYear(), currentDate.getMonth()); });
        nextMonthButton.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(currentDate.getFullYear(), currentDate.getMonth()); });
        goToTodayBtn.addEventListener('click', () => { console.log("Navigating to today"); currentDate = new Date(); renderCalendar(currentDate.getFullYear(), currentDate.getMonth()); });
        function updateShiftSummary(counts) { /* ... no changes ... */ if (!activeCalendarName || !shiftSummaryElement) return; let summaryHtml = "<strong>Resumen Mes:</strong> "; let totalShifts = 0; Object.keys(shiftTypes).forEach(key => { const count = counts[key] || 0; totalShifts += count; summaryHtml += `<span class="shift-${key}" title="${shiftTypes[key].label}">${key}: ${count}</span>`; }); if (totalShifts > 0) { shiftSummaryElement.innerHTML = summaryHtml; shiftSummaryElement.style.display = 'block'; } else { shiftSummaryElement.style.display = 'none'; } }

        // --- Edit Controls Toggle ---
        function toggleEditControlsVisibility() { /* ... no changes ... */ if (!activeCalendarName) { alert("Selecciona o crea un calendario primero."); return; } const controls = editControlsWrapper; if (!controls) return; const isHidden = controls.style.display === 'none'; controls.style.display = isHidden ? 'block' : 'none'; console.log(`Edit controls ${isHidden ? 'shown' : 'hidden'}`); if (!isHidden) { if (isSelectingPattern) { cancelPatternSelection(true); } if (selectedShiftType !== null) { const activeButton = shiftSelectorContainer.querySelector(`.shift-button[data-shift-type="${selectedShiftType}"]`); if (activeButton) selectShift(selectedShiftType, activeButton); } } }

        // --- Custom Tooltip Functions ---
        function showCustomTooltip(event, text) { /* ... no changes ... */ if (!customTooltipElement || !text) return; customTooltipElement.innerHTML = text.replace(/\n/g, '<br>'); customTooltipElement.style.display = 'block'; let x = event.clientX + 10; let y = event.clientY + 10; const tooltipRect = customTooltipElement.getBoundingClientRect(); const bodyRect = document.body.getBoundingClientRect(); if (x + tooltipRect.width > bodyRect.width - 5) { x = event.clientX - tooltipRect.width - 10; } if (y + tooltipRect.height > window.innerHeight - 5) { y = event.clientY - tooltipRect.height - 10; } if (x < 5) x = 5; if (y < 5) y = 5; customTooltipElement.style.left = `${x}px`; customTooltipElement.style.top = `${y}px`; }
        function hideCustomTooltip() { /* ... no changes ... */ if (customTooltipElement) { customTooltipElement.style.display = 'none'; } }

        // --- Day Detail Modal Functions ---
        function openDayDetailModal(dateString) { /* ... no changes ... */ if (!activeCalendarName) return; const calendarData = calendarsData[activeCalendarName]; const dayData = calendarData[dateString] || {}; const dateObj = parseDateString(dateString); const displayDate = dateObj.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); dayDetailModalTitle.textContent = `Detalles: ${displayDate}`; dayDetailEditingDateInput.value = dateString; dayDetailNoteTextarea.value = dayData.note || ''; dayDetailExtraInfoInput.value = dayData.extra || ''; dayDetailEventCheckbox.checked = dayData.event || false; dayDetailModalOverlay.style.display = 'flex'; dayDetailNoteTextarea.focus(); }
        function closeDayDetailModal() { /* ... no changes ... */ dayDetailModalOverlay.style.display = 'none'; }
        function saveDayDetails() { /* ... no changes ... */ const dateString = dayDetailEditingDateInput.value; if (!activeCalendarName || !dateString) return; const calendarData = calendarsData[activeCalendarName]; const note = dayDetailNoteTextarea.value.trim(); const extra = dayDetailExtraInfoInput.value.trim(); const isEvent = dayDetailEventCheckbox.checked; const existingShift = calendarData[dateString]?.shift; const hasData = !!existingShift || !!note || !!extra || isEvent; if (hasData) { if (!calendarData[dateString]) { calendarData[dateString] = {}; } if (note) calendarData[dateString].note = note; else delete calendarData[dateString].note; if (extra) calendarData[dateString].extra = extra; else delete calendarData[dateString].extra; if (isEvent) calendarData[dateString].event = true; else delete calendarData[dateString].event; if (existingShift) calendarData[dateString].shift = existingShift; } else { delete calendarData[dateString]; } console.log(`Details saved for ${dateString}:`, calendarData[dateString] || '(Entry deleted)'); saveData(); renderCalendar(currentDate.getFullYear(), currentDate.getMonth()); closeDayDetailModal(); }

        // --- Export / Import Functions ---
        function exportCalendarData() { /* ... no changes ... */ if (!activeCalendarName || !calendarsData[activeCalendarName]) { alert("No hay un calendario activo para exportar."); return; } try { const dataToExport = calendarsData[activeCalendarName]; const jsonData = JSON.stringify(dataToExport, null, 2); const blob = new Blob([jsonData], { type: 'application/json' }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; const safeCalName = activeCalendarName.replace(/[^a-z0-9]/gi, '_').toLowerCase(); link.download = `calendario_${safeCalName}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(url); console.log(`Calendario "${activeCalendarName}" exportado.`); alert(`Calendario "${activeCalendarName}" exportado como ${link.download}`); } catch (error) { console.error("Error al exportar el calendario:", error); alert("Error al exportar el calendario. Revisa la consola para más detalles."); } }
        function triggerImport() { /* ... no changes ... */ importFileInput.click(); }
        function importCalendarData(event) { /* ... no changes ... */ const file = event.target.files[0]; if (!file) { console.log("No se seleccionó ningún archivo."); return; } if (!file.name.toLowerCase().endsWith('.json')) { alert("Por favor, selecciona un archivo JSON válido."); event.target.value = ''; return; } const reader = new FileReader(); reader.onload = (e) => { let importedData; try { importedData = JSON.parse(e.target.result); if (typeof importedData !== 'object' || importedData === null || Array.isArray(importedData)) { throw new Error("El archivo JSON no contiene un objeto de calendario válido."); } console.log("Archivo JSON leído y parseado:", importedData); } catch (error) { console.error("Error al leer o parsear el archivo JSON:", error); alert(`Error al importar: ${error.message}`); event.target.value = ''; return; } let baseName = file.name.replace(/\.json$/i, ''); let newCalName = prompt(`Introduce un nombre para el calendario importado (sugerido: "${baseName}"):`, baseName); if (!newCalName) { alert("Importación cancelada."); event.target.value = ''; return; } newCalName = newCalName.trim(); if (calendarsData[newCalName]) { if (!confirm(`El calendario "${newCalName}" ya existe. ¿Quieres sobrescribirlo con los datos importados?`)) { alert("Importación cancelada."); event.target.value = ''; return; } console.log(`Sobrescribiendo calendario: ${newCalName}`); } calendarsData[newCalName] = importedData; if (!calendarList.includes(newCalName)) { calendarList.push(newCalName); calendarList.sort(); } activeCalendarName = newCalName; console.log(`Calendario "${newCalName}" importado/actualizado.`); saveData(); updateCalendarSelector(); renderCalendar(currentDate.getFullYear(), currentDate.getMonth()); showMainCalendarArea(true); alert(`Calendario "${newCalName}" importado correctamente.`); event.target.value = ''; }; reader.onerror = (e) => { console.error("Error al leer el archivo:", e); alert("Error al leer el archivo."); event.target.value = ''; }; reader.readAsText(file); }


        // --- Application Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM loaded. Initializing application v5.3 (UX Fixes)...");

            loadInitialTheme(); loadData(); updateCalendarSelector(); createShiftSelectorButtons();

            // Mobile Menu Listeners
            if (menuToggleBtnBottom) menuToggleBtnBottom.addEventListener('click', openMobileMenu);
            if (closeMenuBtn) closeMenuBtn.addEventListener('click', closeMobileMenu);
            if (menuOverlay) menuOverlay.addEventListener('click', closeMobileMenu); // Close on overlay click
             if (mobileMenu) {
                 // Close menu when clicking non-action items
                 mobileMenu.querySelectorAll('a.menu-link, button#startTutorialBtnMobile').forEach(item => {
                     item.addEventListener('click', closeMobileMenu);
                 });
                 // Buttons that perform actions and then close
                 if (editShiftsBtnMobile) { editShiftsBtnMobile.addEventListener('click', () => { toggleEditControlsVisibility(); closeMobileMenu(); }); }
                 if (themeToggleBtnMobile) themeToggleBtnMobile.addEventListener('click', toggleTheme); // Closes itself
                 if (exportBtnMobile) { exportBtnMobile.addEventListener('click', () => { exportCalendarData(); closeMobileMenu(); }); }
                 if (importBtnMobile) { importBtnMobile.addEventListener('click', () => { triggerImport(); /* Keep menu open */ }); }
                 // Calendar management actions in menu
                 if (addCalendarBtnMobile) { addCalendarBtnMobile.addEventListener('click', addCalendar); } // Closes itself
                 if (deleteCalendarBtnMobile) { deleteCalendarBtnMobile.addEventListener('click', deleteCalendar); } // Doesn't close
                 if (calendarSelectorMobile) { calendarSelectorMobile.addEventListener('change', selectCalendar); } // Closes itself
             }

            // Import file input listener
            if (importFileInput) importFileInput.addEventListener('change', importCalendarData);

            // Action Listeners (Bottom Bar - Desktop)
            if (editShiftsBtnBottom) editShiftsBtnBottom.addEventListener('click', toggleEditControlsVisibility);
            if (startTutorialBtnBottom) startTutorialBtnBottom.addEventListener('click', showTutorialPopup); // Corrected listener
            if (themeToggleBtnBottom) themeToggleBtnBottom.addEventListener('click', toggleTheme);

            // Tutorial Listeners
            tutorialCloseBtn.addEventListener('click', () => hideTutorialPopup(true));
            tutorialOverlay.addEventListener('click', (event) => { if (event.target === tutorialOverlay) hideTutorialPopup(false); });

            // Pattern Controls Listeners
            startPatternSelectionBtn.addEventListener('click', togglePatternSelectionMode);
            applySelectedPatternBtn.addEventListener('click', applySelectedPattern);
            cancelPatternSelectionBtn.addEventListener('click', () => cancelPatternSelection(true));

            // Modal Listeners
            if (dayDetailSaveBtn) dayDetailSaveBtn.addEventListener('click', saveDayDetails);
            if (dayDetailCancelBtn) dayDetailCancelBtn.addEventListener('click', closeDayDetailModal);
            if (dayDetailModalOverlay) { dayDetailModalOverlay.addEventListener('click', (event) => { if (event.target === dayDetailModalOverlay) { closeDayDetailModal(); } }); }


            // Initial Render State
            renderCalendar(currentDate.getFullYear(), currentDate.getMonth()); // Render calendar grid always
            if (!activeCalendarName) {
                 showMainCalendarArea(false); // Hide details if no calendar active initially
            }
            if (editControlsWrapper) editControlsWrapper.style.display = 'none';
            updateEditButtonsState(); // Set initial state for edit/export buttons

            // First time user checks and hints
            const storedVersion = localStorage.getItem(APP_VERSION_KEY);
            const currentVersion = 'v5.3'; // Match version in console log
            const tutorialCompleted = localStorage.getItem(TUTORIAL_COMPLETED_KEY);
            firstTimeUser = !tutorialCompleted; // Set flag

            if (firstTimeUser && calendarList.length === 0) {
                 // Highlight menu button if first time and no calendars
                 if (menuToggleBtnBottom) {
                     menuToggleBtnBottom.classList.add('pulsate-glow');
                     // Remove glow once clicked
                     menuToggleBtnBottom.addEventListener('click', () => {
                        menuToggleBtnBottom.classList.remove('pulsate-glow');
                     }, { once: true });
                 }
                 // Show tutorial automatically only if truly first time
                 setTimeout(showTutorialPopup, 500);
            } else if (storedVersion !== currentVersion) {
                 console.log(`App updated from ${storedVersion} to ${currentVersion}.`);
                 // Optionally show tutorial again if major changes:
                 // if (!tutorialCompleted) setTimeout(showTutorialPopup, 500); // Show only if they never completed old one
            }
            // Update stored version
            localStorage.setItem(APP_VERSION_KEY, currentVersion);


            console.log("Initialization complete.");
        });
    </script>

</body>
</html>
