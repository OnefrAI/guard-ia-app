<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Turnos Multi-Calendario (Mejorado)</title>
    <!-- Tailwind CSS para un diseño rápido y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <!-- Google Fonts para una tipografía limpia -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Paleta de Colores y Variables CSS --- */
        :root {
            /* Modo Oscuro (Por defecto) */
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --bg-tertiary: #2a2a2a;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --border-primary: rgba(255, 255, 255, 0.15);
            --border-secondary: rgba(255, 255, 255, 0.1);
            --accent-primary: #39FF14; /* Verde Neón */
            --accent-text: #0a0a0a;
            --interactive-hover: rgba(255, 255, 255, 0.08);
            --danger-primary: #b91c1c;
            --danger-hover: #991b1b;
            --danger-text: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.5);

            /* Colores de Turnos */
            --shift-m-bg: #2563eb;
            --shift-t-bg: #d97706;
            --shift-n-bg: #7c3aed;
            --shift-l-bg: #059669;
            --shift-text: #ffffff;
        }

        body.light-mode {
            /* Modo Claro */
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f3f5;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-primary: rgba(0, 0, 0, 0.1);
            --border-secondary: rgba(0, 0, 0, 0.08);
            --accent-primary: #007bff; /* Azul */
            --accent-text: #ffffff;
            --interactive-hover: rgba(0, 0, 0, 0.05);
            --danger-primary: #dc3545;
            --danger-hover: #c82333;
            --danger-text: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.1);

            /* Colores de Turnos */
            --shift-m-bg: #60a5fa;
            --shift-t-bg: #fbbf24;
            --shift-n-bg: #a78bfa;
            --shift-l-bg: #34d399;
            --shift-text: #1f2937;
        }

        /* --- Estilos Base y Transiciones --- */
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- Estilos de Componentes Reutilizables --- */
        .card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 0.75rem;
            box-shadow: 0 4px 15px var(--shadow-color);
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border: none;
        }
        .btn:hover { transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; filter: grayscale(50%); }

        .btn-primary { background-color: var(--accent-primary); color: var(--accent-text); }
        .btn-primary:hover:not(:disabled) { filter: brightness(1.1); }
        .btn-secondary { background-color: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-primary); }
        .btn-secondary:hover:not(:disabled) { background-color: var(--interactive-hover); }
        .btn-danger { background-color: var(--danger-primary); color: var(--danger-text); }
        .btn-danger:hover:not(:disabled) { background-color: var(--danger-hover); }

        .form-input, .form-select {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-primary);
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px var(--accent-primary);
        }

        /* --- Estilos Específicos de la App --- */
        .calendar-grid { display: grid; grid-template-columns: repeat(8, minmax(0, 1fr)); }
        .day-cell {
            min-height: 6.5rem;
            padding: 0.35rem;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: background-color 0.2s ease;
            border-right: 1px solid var(--border-secondary);
            border-bottom: 1px solid var(--border-secondary);
            cursor: pointer;
            overflow: hidden;
        }
        .day-cell:nth-child(8n) { border-right: none; }
        .calendar-grid .day-cell:hover:not(.other-month):not(.week-number-cell) { background-color: var(--interactive-hover); }
        .day-number {
            font-size: 0.875rem; font-weight: 500; width: 1.75rem; height: 1.75rem;
            display: flex; align-items: center; justify-content: center;
            border-radius: 9999px; margin-bottom: 0.25rem; flex-shrink: 0;
        }
        .current-day .day-number { background-color: var(--accent-primary); color: var(--accent-text); }
        .other-month { color: var(--text-secondary); opacity: 0.6; cursor: default; }
        .week-number-cell { color: var(--text-secondary); font-size: 0.75rem; cursor: default !important; background-color: transparent !important; align-items: center; justify-content: center; border-right: 1px solid var(--border-primary); }
        
        .shift-indicator { font-size: 0.75rem; font-weight: 600; padding: 0.1rem 0.4rem; border-radius: 0.25rem; color: var(--shift-text); width: 100%; text-align: center; }
        .note-indicator { font-size: 0.9rem; color: var(--text-secondary); position: absolute; top: 2px; right: 4px; }
        .shift-M { background-color: var(--shift-m-bg); }
        .shift-T { background-color: var(--shift-t-bg); }
        .shift-N { background-color: var(--shift-n-bg); }
        .shift-L { background-color: var(--shift-l-bg); }
        body.light-mode .shift-T, body.light-mode .shift-L { color: #1f2937; }

        .pattern-start-date, .pattern-end-date { background-color: var(--accent-primary) !important; }
        .pattern-start-date .day-number, .pattern-end-date .day-number { color: var(--accent-text) !important; }

        /* --- Modal y Toast --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: var(--bg-secondary);
            padding: 1.5rem 2rem; border-radius: 0.75rem;
            width: 90%; max-width: 500px;
            border: 1px solid var(--border-primary);
            transform: scale(0.95); transition: transform 0.3s ease;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }

        .toast-container {
            position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 1100;
            display: flex; flex-direction: column; gap: 0.5rem;
        }
        .toast {
            background-color: var(--bg-tertiary); color: var(--text-primary);
            padding: 0.75rem 1.25rem; border-radius: 0.5rem;
            box-shadow: 0 5px 15px var(--shadow-color);
            border-left: 4px solid var(--accent-primary);
            opacity: 0; transform: translateX(100%);
            animation: slideIn 0.5s forwards, fadeOut 0.5s 2.5s forwards;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

    </style>
</head>
<body class="dark-mode">
    <div id="app-loader" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-[2000]">
        <div class="text-white text-xl flex items-center gap-3">
            <i class="fas fa-spinner fa-spin text-3xl"></i>
            <span>Conectando...</span>
        </div>
    </div>

    <div class="max-w-5xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Cabecera -->
        <header class="flex justify-between items-center mb-6 pb-4 border-b border-[var(--border-primary)]">
            <!-- CORRECCIÓN: Se cambia el enlace a la raíz del sitio "/" para mayor fiabilidad -->
            <a href="/" target="_top" class="text-[var(--text-primary)] hover:text-[var(--accent-primary)] transition-colors flex items-center gap-3">
                <i class="fas fa-arrow-left text-xl"></i>
                <h2 class="text-lg font-semibold hidden sm:block">Volver a GUARD-IA</h2>
            </a>
            <div class="flex items-center gap-2">
                <button id="startTutorialBtn" class="btn btn-secondary !p-2 sm:!px-4" title="Guía interactiva">
                    <i class="fas fa-question-circle"></i><span class="hidden sm:inline">Guía</span>
                </button>
                <button id="themeToggleBtn" class="btn btn-secondary !p-2 sm:!px-4" title="Cambiar tema"></button>
            </div>
        </header>

        <main id="app-content" class="hidden">
            <h1 class="text-2xl sm:text-3xl font-bold text-center mb-6">Calendario del GUARD-IA</h1>

            <!-- Panel de Gestión de Calendarios -->
            <section id="calendarManagement" class="card p-4 mb-6 flex flex-wrap items-center justify-center gap-4">
                <label for="calendarSelector" class="font-medium">Calendario:</label>
                <select id="calendarSelector" class="form-select flex-grow sm:flex-grow-0 sm:w-48"></select>
                <input type="text" id="newCalendarName" class="form-input flex-grow sm:flex-grow-0 sm:w-48" placeholder="Nuevo calendario...">
                <button id="addCalendarBtn" class="btn btn-primary"><i class="fas fa-plus"></i><span class="hidden sm:inline">Añadir</span></button>
                <button id="deleteCalendarBtn" class="btn btn-danger"><i class="fas fa-trash-alt"></i><span class="hidden sm:inline">Eliminar</span></button>
            </section>

            <!-- Área Principal del Calendario (se muestra al seleccionar uno) -->
            <section id="mainCalendarArea" class="hidden">
                <div class="card p-4 sm:p-6">
                    <div class="flex justify-between items-center mb-4">
                        <button id="prevMonth" class="btn btn-secondary !p-2 sm:!px-3" aria-label="Mes anterior"><i class="fas fa-chevron-left"></i></button>
                        <h2 id="currentMonthYear" class="text-xl sm:text-2xl font-semibold text-center flex-grow mx-2"></h2>
                        <button id="nextMonth" class="btn btn-secondary !p-2 sm:!px-3" aria-label="Mes siguiente"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div>
                        <div class="calendar-grid text-center text-sm font-medium text-[var(--text-secondary)] pb-2 mb-2 border-b border-[var(--border-primary)]">
                            <div class="font-normal">Sem</div><div>L</div><div>M</div><div>X</div><div>J</div><div>V</div><div>S</div><div>D</div>
                        </div>
                        <div id="calendarGrid" class="calendar-grid"></div>
                    </div>
                    <!-- Resumen de Turnos -->
                    <div id="shiftSummary" class="mt-4 pt-4 border-t border-[var(--border-primary)] flex flex-wrap justify-center gap-x-4 gap-y-2">
                    </div>
                </div>

                <div class="text-center mt-4">
                    <button id="toggleEditControlsBtn" class="btn btn-secondary"><i class="fas fa-edit"></i> Editar Turnos/Patrón</button>
                </div>

                <!-- Controles de Edición -->
                <div id="editControlsWrapper" class="hidden mt-4 space-y-4">
                    <div class="card p-4 flex flex-wrap items-center justify-center gap-2">
                        <span class="font-medium text-sm mr-2">Asignar:</span>
                        <div id="shiftSelector" class="contents"></div>
                        <button class="btn !bg-[var(--danger-primary)] !text-[var(--danger-text)]" data-shift-type="erase" title="Borrar turno"><i class="fas fa-eraser"></i> Borrar</button>
                    </div>

                    <div id="patternControls" class="card p-4 text-center">
                        <div id="patternSelectionArea" class="flex flex-wrap items-center justify-center gap-3">
                            <span class="font-medium text-sm">Repetir Patrón:</span>
                            <button id="startPatternSelectionBtn" class="btn btn-primary text-sm">Seleccionar Patrón</button>
                            <p id="patternInfo" class="w-full text-sm text-[var(--text-secondary)] mt-2"></p>
                        </div>
                        <div id="patternApplyArea" class="hidden space-y-3">
                            <div id="selectedPatternDisplay" class="bg-[var(--bg-primary)] p-2 rounded-md text-sm text-[var(--text-secondary)] border border-[var(--border-primary)]"></div>
                            <div class="flex flex-wrap gap-3 justify-center items-center">
                                <label for="applyUntilDate" class="text-sm font-medium">Extender hasta:</label>
                                <input type="date" id="applyUntilDate" class="form-input text-sm">
                                <button id="applySelectedPatternBtn" class="btn btn-primary text-sm">Aplicar</button>
                                <button id="cancelPatternSelectionBtn" class="btn btn-secondary text-sm">Cancelar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <p id="footer-status" class="text-center text-sm text-[var(--text-secondary)] mt-6">(Selecciona o crea un calendario para empezar)</p>
        </main>
    </div>

    <!-- Contenedor de Modales -->
    <div id="modal-container"></div>
    <!-- Contenedor de Notificaciones Toast -->
    <div id="toast-container" class="toast-container"></div>

<script type="module">
    // --- Firebase SDK Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, collection, onSnapshot, doc, setDoc, deleteDoc, addDoc, 
        writeBatch, deleteField, serverTimestamp, query, orderBy
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Configuración y Estado de la Aplicación ---
    const firebaseConfig = {
        apiKey: "AIzaSyAf3I3_aW__lBtTVlEJ9xesIWkEJ6lMJp8",
        authDomain: "guard-ia-a36da.firebaseapp.com",
        projectId: "guard-ia-a36da",
        storageBucket: "guard-ia-a36da.appspot.com",
        messagingSenderId: "914018061004",
        appId: "1:914018061004:web:6ab6c6ca728199033bd069",
        measurementId: "G-W45Z1BH3T4"
    };

    // Inicialización de Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const SHIFT_TYPES = {
        'M': { label: 'Mañana', colorClass: 'shift-M' },
        'T': { label: 'Tarde', colorClass: 'shift-T' },
        'N': { label: 'Noche', colorClass: 'shift-N' },
        'L': { label: 'Libre', colorClass: 'shift-L' },
    };
    const MONTH_NAMES = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

    const state = {
        currentDate: new Date(),
        selectedShiftType: null,
        calendars: {},
        activeCalendarId: null,
        shiftData: {},
        isSelectingPattern: false,
        patternStartDate: null,
        patternEndDate: null,
        selectedPatternSequence: [],
        userId: null,
        unsubscribeCalendars: null,
        unsubscribeShifts: null,
    };

    // --- Selectores del DOM ---
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);

    // --- Funciones de Utilidad (Fechas, UI) ---
    const formatDate = (date) => date.toISOString().split('T')[0];
    const parseDate = (dateString) => new Date(dateString + 'T12:00:00Z');
    const getWeekNumber = (d) => {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    };

    const showToast = (message) => {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        $('#toast-container').appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    };

    const showModal = ({ title, body, actions }) => {
        const modalId = `modal-${Date.now()}`;
        const modalHTML = `
            <div id="${modalId}" class="modal-overlay">
                <div class="modal-content space-y-4">
                    <h3 class="text-xl font-bold text-center">${title}</h3>
                    <div>${body}</div>
                    <div class="flex justify-end gap-3 mt-4">${actions}</div>
                </div>
            </div>
        `;
        $('#modal-container').insertAdjacentHTML('beforeend', modalHTML);
        
        const modalElement = $(`#${modalId}`);
        requestAnimationFrame(() => {
            modalElement.classList.add('visible');
        });

        return modalId;
    };

    const closeModal = (modalId) => {
        const modalElement = $(`#${modalId}`);
        if (modalElement) {
            modalElement.classList.remove('visible');
            modalElement.addEventListener('transitionend', () => modalElement.remove(), { once: true });
        }
    };

    const showConfirm = (title, message) => {
        return new Promise(resolve => {
            const body = `<p>${message}</p>`;
            const actions = `
                <button class="btn btn-secondary" data-action="cancel">Cancelar</button>
                <button class="btn btn-danger" data-action="confirm">Confirmar</button>
            `;
            const modalId = showModal({ title, body, actions });
            $(`#${modalId}`).addEventListener('click', e => {
                const action = e.target.closest('button')?.dataset.action;
                if (action) {
                    closeModal(modalId);
                    resolve(action === 'confirm');
                }
            });
        });
    };

    const showPrompt = (title, label, defaultValue = '') => {
        return new Promise(resolve => {
            const body = `
                <label for="modal-input" class="block text-sm font-medium mb-2">${label}</label>
                <textarea id="modal-input" class="form-input w-full" rows="3">${defaultValue}</textarea>
            `;
            const actions = `
                <button class="btn btn-secondary" data-action="cancel">Cancelar</button>
                <button class="btn btn-primary" data-action="save">Guardar</button>
            `;
            const modalId = showModal({ title, body, actions });
            const input = $(`#${modalId} #modal-input`);
            input.focus();
            input.select();

            $(`#${modalId}`).addEventListener('click', e => {
                const action = e.target.closest('button')?.dataset.action;
                if (action) {
                    closeModal(modalId);
                    resolve(action === 'save' ? input.value : null);
                }
            });
        });
    };

    // --- Lógica Principal de la App ---
    const waitForAuthInit = () => {
        return new Promise((resolve) => {
            const unsubscribe = onAuthStateChanged(auth, (user) => {
                unsubscribe();
                resolve(user);
            });
        });
    };

    async function initializeAppForUser(user) {
        state.userId = user.uid;
        $('#app-loader').style.display = 'none';
        $('#app-content').classList.remove('hidden');
        
        setupEventListeners();
        applyInitialTheme();
        createShiftSelectorButtons();
        await listenForUserCalendars();

        if (!localStorage.getItem('multiCalendarTutorialCompleted_v3')) {
            setTimeout(() => showTutorialPopup(), 500);
        }
    }

    function showLoginScreen() {
        $('#app-loader').style.display = 'none';
        const main = $('main');
        main.innerHTML = `<div class="card p-6 text-center"><p>Debes iniciar sesión para usar el calendario. <a href="/" target="_top" class="font-bold text-[var(--accent-primary)]">Volver a la página principal para iniciar sesión.</a></p></div>`;
        main.classList.remove('hidden');
    }

    // --- Firestore ---
    function listenForUserCalendars() {
        if (state.unsubscribeCalendars) state.unsubscribeCalendars();
        const calendarsRef = collection(db, 'users', state.userId, 'calendars');
        
        state.unsubscribeCalendars = onSnapshot(calendarsRef, (snapshot) => {
            state.calendars = {};
            snapshot.forEach(doc => {
                state.calendars[doc.id] = doc.data();
            });
            updateCalendarSelector();
            
            const lastActive = localStorage.getItem(`lastActiveCal_${state.userId}`);
            if (lastActive && state.calendars[lastActive]) {
                selectCalendar(lastActive);
            } else if (snapshot.docs.length > 0) {
                const sortedIds = Object.keys(state.calendars).sort((a, b) => 
                    (state.calendars[a].name || '').localeCompare(state.calendars[b].name || '')
                );
                selectCalendar(sortedIds[0]);
            } else {
                showMainCalendarArea(false);
            }
        }, (error) => {
            console.error("Error en listener de calendarios:", error);
            showToast("Error de permisos al cargar calendarios.");
        });
    }

    function listenForShiftData(calendarId) {
        if (state.unsubscribeShifts) state.unsubscribeShifts();
        const shiftsRef = collection(db, 'users', state.userId, 'calendars', calendarId, 'shifts');

        state.shiftData = {};
        state.unsubscribeShifts = onSnapshot(shiftsRef, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === "added" || change.type === "modified") {
                    state.shiftData[change.doc.id] = change.doc.data();
                }
                if (change.type === "removed") {
                    delete state.shiftData[change.doc.id];
                }
            });
            renderCalendar();
        }, (error) => {
            console.error("Error en listener de turnos:", error);
            showToast("Error de permisos al cargar turnos.");
        });
    }

    async function addCalendar() {
        const name = $('#newCalendarName').value.trim();
        if (!name) return showToast("El nombre del calendario no puede estar vacío.");
        
        try {
            const calendarsRef = collection(db, 'users', state.userId, 'calendars');
            const newDocRef = await addDoc(calendarsRef, { name, createdAt: serverTimestamp() });
            showToast(`Calendario "${name}" creado.`);
            $('#newCalendarName').value = '';
            selectCalendar(newDocRef.id);
        } catch (e) {
            console.error("Error añadiendo calendario:", e);
            showToast("Error al crear el calendario.");
        }
    }

    async function deleteCalendar() {
        const id = state.activeCalendarId;
        if (!id) return;
        
        const confirmed = await showConfirm("Eliminar Calendario", `¿Seguro que quieres eliminar "${state.calendars[id].name}"? Se borrarán todos sus turnos de forma permanente.`);
        if (!confirmed) return;

        try {
            await deleteDoc(doc(db, 'users', state.userId, 'calendars', id));
            showToast("Calendario eliminado.");
        } catch (e) {
            console.error("Error eliminando calendario:", e);
            showToast("Error al eliminar el calendario.");
        }
    }
    
    async function saveShiftData(dateString, data) {
        if (!state.activeCalendarId) return;
        const shiftDocRef = doc(db, 'users', state.userId, 'calendars', state.activeCalendarId, 'shifts', dateString);
        try {
            if (!data.shift && !data.note) {
                await deleteDoc(shiftDocRef);
            } else {
                await setDoc(shiftDocRef, data, { merge: true });
            }
        } catch (e) {
            console.error("Error guardando turno:", e);
        }
    }

    // --- Renderizado y Lógica del Calendario ---
    function renderCalendar() {
        if (!state.activeCalendarId) return;
        const year = state.currentDate.getFullYear();
        const month = state.currentDate.getMonth();

        $('#currentMonthYear').textContent = `${MONTH_NAMES[month]} ${year}`;
        const grid = $('#calendarGrid');
        grid.innerHTML = '';

        const firstDayOfMonth = new Date(year, month, 1);
        const mondayBasedDayOfWeek = (firstDayOfMonth.getDay() + 6) % 7;
        const currentMonday = new Date(firstDayOfMonth);
        currentMonday.setDate(firstDayOfMonth.getDate() - mondayBasedDayOfWeek);

        let html = '';
        for (let week = 0; week < 6; week++) {
            html += `<div class="day-cell week-number-cell">${getWeekNumber(currentMonday)}</div>`;
            for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                const cellDate = new Date(currentMonday);
                cellDate.setDate(currentMonday.getDate() + dayIndex);
                const dateStr = formatDate(cellDate);
                
                const classes = ['day-cell'];
                if (cellDate.getMonth() !== month) classes.push('other-month');
                if (dateStr === formatDate(new Date())) classes.push('current-day');
                if (dateStr === state.patternStartDate) classes.push('pattern-start-date');
                if (dateStr === state.patternEndDate) classes.push('pattern-end-date');
                
                const dayData = state.shiftData[dateStr];
                const shiftHTML = dayData?.shift ? `<div class="shift-indicator ${SHIFT_TYPES[dayData.shift].colorClass}">${dayData.shift}</div>` : '';
                const noteHTML = dayData?.note ? `<i class="fas fa-comment-dots note-indicator" title="${dayData.note}"></i>` : '';

                html += `
                    <div class="${classes.join(' ')}" data-date="${dateStr}" title="${dayData?.note || ''}">
                        ${noteHTML}
                        <span class="day-number">${cellDate.getDate()}</span>
                        ${shiftHTML}
                    </div>
                `;
            }
            currentMonday.setDate(currentMonday.getDate() + 7);
        }
        grid.innerHTML = html;
        updateShiftSummary();
    }

    function updateShiftSummary() {
        const summaryContainer = $('#shiftSummary');
        if (!summaryContainer) return;

        const counts = { M: 0, T: 0, N: 0, L: 0 };
        const currentMonth = state.currentDate.getMonth();
        const currentYear = state.currentDate.getFullYear();

        for (const dateStr in state.shiftData) {
            const date = parseDate(dateStr);
            if (date.getFullYear() === currentYear && date.getMonth() === currentMonth) {
                const shift = state.shiftData[dateStr].shift;
                if (shift && counts.hasOwnProperty(shift)) {
                    counts[shift]++;
                }
            }
        }

        let summaryHTML = '';
        for (const shiftKey in counts) {
            if (counts[shiftKey] > 0) {
                const { label, colorClass } = SHIFT_TYPES[shiftKey];
                summaryHTML += `
                    <div class="flex items-center gap-2 text-sm">
                        <span class="w-3 h-3 rounded-full ${colorClass}"></span>
                        <span>${label}: <strong>${counts[shiftKey]}</strong></span>
                    </div>
                `;
            }
        }
        
        summaryContainer.innerHTML = summaryHTML || `<p class="text-sm text-[var(--text-secondary)]">No hay turnos asignados este mes.</p>`;
    }

    function handleDayClick(e) {
        const cell = e.target.closest('.day-cell');
        if (!cell || !cell.dataset.date || cell.classList.contains('week-number-cell')) return;
        
        const dateString = cell.dataset.date;
        const isOtherMonth = cell.classList.contains('other-month');
        const controlsVisible = !$('#editControlsWrapper').classList.contains('hidden');

        if (state.isSelectingPattern) {
            handlePatternSelectionClick(dateString);
        } else if (controlsVisible && state.selectedShiftType) {
            if (isOtherMonth) return;
            applySingleShift(dateString);
        } else if (controlsVisible) {
            if (isOtherMonth) return;
            manageNoteForDay(dateString);
        }
    }

    function applySingleShift(dateString) {
        const currentData = state.shiftData[dateString] || {};
        let newData = { ...currentData };
        if (state.selectedShiftType === 'erase') {
            delete newData.shift;
        } else {
            newData.shift = state.selectedShiftType;
        }
        saveShiftData(dateString, newData);
    }

    async function manageNoteForDay(dateString) {
        const currentNote = state.shiftData[dateString]?.note || "";
        const newNote = await showPrompt(`Nota para ${dateString}`, 'Escribe tu nota (deja en blanco para borrar):', currentNote);
        
        if (newNote === null) return;
        
        const currentData = state.shiftData[dateString] || {};
        let newData = { ...currentData };
        if (newNote.trim() === "") {
            delete newData.note;
        } else {
            newData.note = newNote.trim();
        }
        saveShiftData(dateString, newData);
    }

    // --- Lógica de Patrones (CORREGIDA) ---
    function startPatternSelection() {
        if (state.isSelectingPattern) {
            cancelPatternSelection();
            return;
        }
        
        // Deseleccionar cualquier turno activo
        selectShift(null);

        state.isSelectingPattern = true;
        state.patternStartDate = null;
        state.patternEndDate = null;
        state.selectedPatternSequence = [];

        $('#patternControls').classList.add('pattern-selecting-active');
        $('#patternInfo').textContent = 'Haz clic en el día de INICIO del patrón...';
        $('#startPatternSelectionBtn').textContent = 'Cancelar Selección';
        $('#startPatternSelectionBtn').classList.replace('btn-primary', 'btn-danger');
        $('#calendarGrid').classList.add('selecting-pattern');
        $('#patternApplyArea').classList.add('hidden');
        $('#patternSelectionArea').classList.remove('hidden');
    }

    function handlePatternSelectionClick(dateString) {
        if (!state.patternStartDate) {
            state.patternStartDate = dateString;
            $('#patternInfo').textContent = 'Ahora haz clic en el día de FIN del patrón.';
        } else {
            state.patternEndDate = dateString;
            let start = parseDate(state.patternStartDate);
            let end = parseDate(state.patternEndDate);

            if (start > end) {
                [start, end] = [end, start];
                [state.patternStartDate, state.patternEndDate] = [formatDate(start), formatDate(end)];
            }
            
            state.selectedPatternSequence = [];
            let iterDate = new Date(start);
            while (iterDate <= end) {
                const dateStr = formatDate(iterDate);
                state.selectedPatternSequence.push(state.shiftData[dateStr]?.shift || null);
                iterDate.setDate(iterDate.getDate() + 1);
            }

            state.isSelectingPattern = false;
            $('#calendarGrid').classList.remove('selecting-pattern');
            $('#patternSelectionArea').classList.add('hidden');
            $('#patternApplyArea').classList.remove('hidden');
            
            const patternHTML = state.selectedPatternSequence.map(s => {
                const type = SHIFT_TYPES[s];
                return `<span class="font-bold ${type ? type.colorClass + ' text-[var(--shift-text)]' : ''} px-1.5 py-0.5 rounded-sm">${s || '-'}</span>`;
            }).join(' ');
            $('#selectedPatternDisplay').innerHTML = `Patrón: ${patternHTML}`;
            
            $('#applySelectedPatternBtn').disabled = $('#applyUntilDate').value === '';
        }
        renderCalendar();
    }

    function cancelPatternSelection() {
        state.isSelectingPattern = false;
        state.patternStartDate = null;
        state.patternEndDate = null;
        state.selectedPatternSequence = [];
        
        $('#applyUntilDate').value = '';
        $('#selectedPatternDisplay').innerHTML = "";
        $('#applySelectedPatternBtn').disabled = true;

        $('#patternControls').classList.remove('pattern-selecting-active');
        $('#startPatternSelectionBtn').textContent = 'Seleccionar Patrón';
        $('#startPatternSelectionBtn').classList.replace('btn-danger', 'btn-primary');
        $('#patternInfo').textContent = '';
        $('#calendarGrid').classList.remove('selecting-pattern');
        $('#patternApplyArea').classList.add('hidden');
        $('#patternSelectionArea').classList.remove('hidden');
        renderCalendar();
    }

    async function applySelectedPattern() {
        const untilValue = $('#applyUntilDate').value;
        if (!untilValue || !state.patternEndDate || state.selectedPatternSequence.length === 0) return;

        const patternEndOriginal = parseDate(state.patternEndDate);
        let repeatStart = new Date(patternEndOriginal);
        repeatStart.setDate(repeatStart.getDate() + 1);
        let untilDate = parseDate(untilValue);

        if (repeatStart > untilDate) return showToast("'Extender hasta' debe ser posterior al fin del patrón.");

        const batch = writeBatch(db);
        let pIndex = 0;
        let currentDateIter = new Date(repeatStart);

        while (currentDateIter <= untilDate) {
            const dateStr = formatDate(currentDateIter);
            const shiftToApply = state.selectedPatternSequence[pIndex % state.selectedPatternSequence.length];
            const shiftDocRef = doc(db, `users/${state.userId}/calendars/${state.activeCalendarId}/shifts/${dateStr}`);

            if (shiftToApply) {
                batch.set(shiftDocRef, { shift: shiftToApply }, { merge: true });
            } else {
                batch.update(shiftDocRef, { shift: deleteField() });
            }
            
            currentDateIter.setDate(currentDateIter.getDate() + 1);
            pIndex++;
        }
        
        try {
            await batch.commit();
            showToast("Patrón aplicado exitosamente.");
            cancelPatternSelection();
        } catch (e) {
            console.error("Error aplicando patrón:", e);
            showToast("Error al aplicar el patrón.");
        }
    }

    // --- Actualizaciones de UI ---
    function updateCalendarSelector() {
        const selector = $('#calendarSelector');
        const calendarIds = Object.keys(state.calendars);
        selector.innerHTML = '';

        if (calendarIds.length === 0) {
            selector.innerHTML = `<option>Crea un calendario</option>`;
            selector.disabled = true;
            $('#deleteCalendarBtn').disabled = true;
        } else {
            selector.disabled = false;
            $('#deleteCalendarBtn').disabled = false;
            const sortedIds = Object.keys(state.calendars).sort((a, b) => 
                (state.calendars[a].name || '').localeCompare(state.calendars[b].name || '')
            );
            sortedIds.forEach(id => {
                selector.innerHTML += `<option value="${id}">${state.calendars[id].name}</option>`;
            });
        }
        if (state.activeCalendarId) {
            selector.value = state.activeCalendarId;
        }
    }

    function showMainCalendarArea(show) {
        $('#mainCalendarArea').classList.toggle('hidden', !show);
        $('#toggleEditControlsBtn').classList.toggle('hidden', !show);
        const statusText = show ? `Mostrando calendario: ${state.calendars[state.activeCalendarId]?.name || ''}` : "(Selecciona o crea un calendario para empezar)";
        $('#footer-status').textContent = statusText;
    }

    function createShiftSelectorButtons() {
        const container = $('#shiftSelector');
        container.innerHTML = '';
        Object.entries(SHIFT_TYPES).forEach(([key, { label, colorClass }]) => {
            const btn = document.createElement('button');
            btn.className = `btn !py-1 !px-3 text-sm ${colorClass} !text-[var(--shift-text)]`;
            btn.dataset.shiftType = key;
            btn.textContent = label;
            container.appendChild(btn);
        });
    }

    function selectShift(shiftKey, clickedButton = null) {
        if (state.isSelectingPattern) {
            cancelPatternSelection();
        }

        $$('#shiftSelector .btn, [data-shift-type="erase"]').forEach(b => b.classList.remove('ring-2', 'ring-offset-2', 'ring-[var(--accent-primary)]'));
        
        if (state.selectedShiftType === shiftKey) {
            state.selectedShiftType = null;
        } else {
            state.selectedShiftType = shiftKey;
            if (clickedButton) {
                clickedButton.classList.add('ring-2', 'ring-offset-2', 'ring-[var(--accent-primary)]');
            }
        }
    }

    function selectCalendar(calendarId) {
        if (!state.calendars[calendarId]) return;
        state.activeCalendarId = calendarId;
        localStorage.setItem(`lastActiveCal_${state.userId}`, calendarId);
        updateCalendarSelector();
        showMainCalendarArea(true);
        listenForShiftData(calendarId);
        cancelPatternSelection();
        $('#editControlsWrapper').classList.add('hidden');
    }

    // --- Tema y Tutorial ---
    function applyInitialTheme() {
        const savedTheme = localStorage.getItem('multiCalendarTheme') || 'dark';
        document.body.classList.toggle('light-mode', savedTheme === 'light');
        updateThemeButton(savedTheme);
    }

    function toggleTheme() {
        const isLight = document.body.classList.toggle('light-mode');
        const newTheme = isLight ? 'light' : 'dark';
        localStorage.setItem('multiCalendarTheme', newTheme);
        updateThemeButton(newTheme);
    }
    
    function updateThemeButton(theme) {
        const isLight = theme === 'light';
        $('#themeToggleBtn').innerHTML = `<i class="fas ${isLight ? 'fa-moon' : 'fa-sun'}"></i><span class="hidden sm:inline">${isLight ? 'Oscuro' : 'Claro'}</span>`;
    }

    function showTutorialPopup() {
        const title = "Guía Rápida del Gestor de Calendarios";
        const body = `
            <ul class="space-y-2 text-sm list-disc list-inside">
                <li><strong>Gestionar Calendarios:</strong> Usa los controles superiores para <strong>crear</strong>, <strong>seleccionar</strong> o <strong>eliminar</strong> calendarios.</li>
                <li><strong>Editar:</strong> Pulsa <strong>"Editar Turnos/Patrón"</strong> para mostrar los controles de asignación.</li>
                <li><strong>Asignar Turno:</strong> Con los controles visibles, selecciona un turno (Mañana, Tarde, etc.) y haz clic en los días.</li>
                <li><strong>Añadir Nota:</strong> Asegúrate de que <strong>ningún turno esté seleccionado</strong> y haz clic en un día para añadir o editar una nota.</li>
                <li><strong>Repetir Patrón:</strong>
                    <ol class="list-decimal list-inside pl-4 mt-1">
                        <li>Asigna los turnos base en el calendario.</li>
                        <li>Pulsa <strong>"Seleccionar Patrón"</strong>.</li>
                        <li>Haz clic en el día de <strong>inicio</strong> y luego en el de <strong>fin</strong> del patrón.</li>
                        <li>Elige una fecha en <strong>"Extender hasta"</strong> y pulsa <strong>"Aplicar"</strong>.</li>
                    </ol>
                </li>
            </ul>
        `;
        const actions = `<button class="btn btn-primary" data-action="close">Entendido</button>`;
        const modalId = showModal({ title, body, actions });
        $(`#${modalId}`).addEventListener('click', e => {
            if (e.target.closest('button')?.dataset.action === 'close') {
                closeModal(modalId);
                localStorage.setItem('multiCalendarTutorialCompleted_v3', 'true');
            }
        });
    }

    // --- Listeners de Eventos ---
    function setupEventListeners() {
        $('#themeToggleBtn').addEventListener('click', toggleTheme);
        $('#startTutorialBtn').addEventListener('click', showTutorialPopup);
        $('#addCalendarBtn').addEventListener('click', addCalendar);
        $('#deleteCalendarBtn').addEventListener('click', deleteCalendar);
        $('#calendarSelector').addEventListener('change', (e) => selectCalendar(e.target.value));
        
        $('#prevMonth').addEventListener('click', () => { state.currentDate.setMonth(state.currentDate.getMonth() - 1); renderCalendar(); });
        $('#nextMonth').addEventListener('click', () => { state.currentDate.setMonth(state.currentDate.getMonth() + 1); renderCalendar(); });
        
        $('#toggleEditControlsBtn').addEventListener('click', () => {
            $('#editControlsWrapper').classList.toggle('hidden');
        });

        $('#editControlsWrapper').addEventListener('click', e => {
            const shiftButton = e.target.closest('[data-shift-type]');
            if (shiftButton) {
                selectShift(shiftButton.dataset.shiftType, shiftButton);
            }
        });
        
        $('#calendarGrid').addEventListener('click', handleDayClick);

        $('#startPatternSelectionBtn').addEventListener('click', startPatternSelection);
        $('#cancelPatternSelectionBtn').addEventListener('click', cancelPatternSelection);
        $('#applySelectedPatternBtn').addEventListener('click', applySelectedPattern);
        $('#applyUntilDate').addEventListener('change', () => {
            $('#applySelectedPatternBtn').disabled = $('#applyUntilDate').value === '' || state.selectedPatternSequence.length === 0;
        });
    }

    // --- Punto de Entrada de la App ---
    async function init() {
        try {
            const user = await waitForAuthInit();
            if (user) {
                await initializeAppForUser(user);
            } else {
                showLoginScreen();
            }
        } catch (error) {
            console.error("Fallo en la inicialización de la autenticación:", error);
            showLoginScreen();
        }
    }

    init();

</script>

</body>
</html>
