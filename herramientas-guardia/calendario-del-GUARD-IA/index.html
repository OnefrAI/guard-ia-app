<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Turnos - GUARD-IA</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #121212; --card-color: #1e1e1e; --text-color: #e0e0e0; --text-medium-color: #a0a0a0;
            --accent-color: #39FF14; --accent-text-color: #0a0a0a; --border-color: rgba(255, 255, 255, 0.15);
            --cell-border-color: rgba(255, 255, 255, 0.1); --button-hover-bg: rgba(255, 255, 255, 0.08);
            --cancel-button-bg: #b91c1c; --cancel-button-text: #ffffff; --week-number-color: var(--text-medium-color);
            --input-bg: #2a2a2a; --input-border: var(--border-color); --input-text: var(--text-color);
            --button-primary-bg: var(--accent-color); --button-primary-text: var(--accent-text-color); --button-primary-hover-bg: #2aff00;
            --button-secondary-bg: #3a3a3a; --button-secondary-text: var(--text-color); --button-secondary-hover-bg: #4a4a4a;
            --button-delete-bg: var(--cancel-button-bg); --button-delete-text: var(--cancel-button-text); --button-delete-hover-bg: #991b1b;
            --shift-m-bg: #2563eb; --shift-t-bg: #d97706; --shift-n-bg: #7c3aed; --shift-l-bg: #059669;
            --shift-text-light: #ffffff; --shift-text-dark: #ffffff; --note-text-color: var(--text-medium-color);
        }
        .home-button { position: fixed; top: 1rem; left: 1rem; z-index: 1101; background: #1f2937; color: white; padding: 0.6rem 0.8rem; border-radius: 0.6rem; font-size: 1rem; text-decoration: none; }
        .loader-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        .loader { border: 4px solid rgba(255,255,255,0.2); border-top: 4px solid var(--accent-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none; }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: 'Inter', sans-serif; }
        .main-container { max-width: 56rem; margin: auto; padding: 1rem; }
        .calendar-container { background-color: var(--card-color); padding: 1rem; border-radius: 0.5rem; }
        .calendar-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .calendar-grid-header { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; padding-bottom: 0.5rem; margin-bottom: 0.5rem; border-bottom: 1px solid #374151; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; }
        .day-cell { min-height: 6rem; background-color: #2b2b2b; padding: 0.5rem; transition: background-color 0.2s; }
        .day-cell:not(.other-month):hover { background-color: #4b4b4b; cursor: pointer; }
        .day-number { font-weight: 500; }
        .other-month { color: #6b7280; }
        .current-day .day-number { background-color: var(--accent-color); color: var(--accent-text-color); border-radius: 50%; width: 1.75rem; height: 1.75rem; display: inline-flex; align-items: center; justify-content: center; }
        .shift-indicator { font-size: 0.75rem; font-weight: 600; padding: 0.1rem 0.4rem; border-radius: 0.25rem; margin-top: 0.25rem; }
    </style>
</head>
<body class="">
    
    <div id="loader-container" class="loader-container">
        <div class="loader"></div>
    </div>

    <div id="app-container" class="hidden">
        <a href="../../index.html" class="home-button" title="Volver a la página principal">
            <i class="fas fa-house"></i>
        </a>
        <div class="main-container">
            <h1 class="text-2xl font-bold text-center my-4">Calendario GUARD-IA</h1>
            
            <div id="calendarManagement" class="flex flex-wrap gap-x-4 gap-y-3 items-center justify-center p-3 rounded-lg border border-gray-700 bg-gray-800 mb-6">
                <div class="w-full sm:w-auto flex items-center gap-2 flex-grow sm:flex-grow-0">
                    <label for="calendarSelector" class="whitespace-nowrap text-sm font-medium">Calendario:</label>
                    <select id="calendarSelector" class="flex-1 w-full sm:w-auto text-sm rounded bg-gray-700 text-white border-gray-600 focus:ring-green-500 focus:border-green-500"></select>
                </div>
                <div class="w-full sm:w-auto flex items-center gap-2 flex-grow sm:flex-grow-0">
                    <label for="newCalendarName" class="whitespace-nowrap text-sm font-medium">Nuevo:</label>
                    <input type="text" id="newCalendarName" placeholder="Nombre..." class="flex-1 w-full sm:w-auto text-sm rounded bg-gray-700 text-white border-gray-600 focus:ring-green-500 focus:border-green-500">
                </div>
                <div class="w-full sm:w-auto flex justify-center sm:justify-start gap-2 mt-2 sm:mt-0">
                    <button id="addCalendarBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded text-sm"><i class="fas fa-plus"></i> Añadir</button>
                    <button id="deleteCalendarBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded text-sm" disabled><i class="fas fa-trash-alt"></i> Eliminar</button>
                </div>
            </div>

            <div id="mainCalendarArea">
                <div class="calendar-container">
                    <div class="calendar-nav">
                        <button id="prevMonth" class="bg-gray-700 p-2 rounded">&lt;</button>
                        <h2 id="currentMonthYear" class="text-xl font-semibold"></h2>
                        <button id="nextMonth" class="bg-gray-700 p-2 rounded">&gt;</button>
                    </div>
                    <div id="calendarGridHeader" class="grid-cols-7 text-center font-bold"></div>
                    <div id="calendarGrid" class="grid grid-cols-7"></div>
                </div>
                 <div id="editControlsWrapper" class="mt-4">
                    <button id="toggleEditBtn" class="w-full bg-blue-600 hover:bg-blue-700 p-2 rounded">Editar Turnos</button>
                    <div id="shiftSelector" class="hidden mt-2 p-4 bg-gray-800 rounded flex gap-2 justify-center flex-wrap"></div>
                 </div>
            </div>
             <div class="footer-notes text-center mt-4 text-gray-500 text-sm" style="display: none;"> <p>(Selecciona o crea un calendario para empezar)</p> </div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAf3I3_aW__lBtTVlEJ9xesIWkEJ6lMJp8",
      authDomain: "guard-ia-a36da.firebaseapp.com",
      projectId: "guard-ia-a36da",
      storageBucket: "guard-ia-a36da.appspot.com",
      messagingSenderId: "914018061004",
      appId: "1:914018061004:web:6ab6c6ca728199033bd069",
      measurementId: "G-W45Z1BH3T4"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const loaderContainer = document.getElementById('loader-container');
    const appContainer = document.getElementById('app-container');
    let currentUserId = null;
    let calendarUnsubscribe = null;
    let calendarData = {};

    onAuthStateChanged(auth, user => {
        loaderContainer.classList.add('hidden');
        if (user) {
            currentUserId = user.uid;
            appContainer.classList.remove('hidden');
            initializeCalendar();
        } else {
            // Reintentar con token si existe, sino mostrar mensaje de login
            const token = window.__initial_auth_token;
            if (token) {
                 signInWithCustomToken(auth, token).catch(() => {
                    displayLoginMessage();
                 });
            } else {
                displayLoginMessage();
            }
        }
    });

    function displayLoginMessage() {
        document.body.innerHTML = `<div class="flex items-center justify-center h-screen bg-gray-900 text-white text-center text-xl">Por favor, <a href="../../index.html" class="font-bold underline mx-2">inicia sesión</a> para usar el calendario.</div>`;
    }

    function initializeCalendar() {
        const calendarGrid = document.getElementById('calendarGrid');
        const header = document.getElementById('calendarGridHeader');
        const currentMonthYearEl = document.getElementById('currentMonthYear');
        const shiftSelector = document.getElementById('shiftSelector');
        const toggleEditBtn = document.getElementById('toggleEditBtn');
        const calendarSelector = document.getElementById('calendarSelector');
        const addCalendarBtn = document.getElementById('addCalendarBtn');
        const newCalendarNameInput = document.getElementById('newCalendarName');
        const deleteCalendarBtn = document.getElementById('deleteCalendarBtn');
        const mainCalendarArea = document.getElementById('mainCalendarArea');
        const footerNotes = document.querySelector('.footer-notes');
        
        let currentDate = new Date();
        let activeCalendarName = null;
        let selectedShift = null;

        const shiftTypes = { 'M': 'bg-blue-500', 'T': 'bg-orange-500', 'N': 'bg-purple-500', 'L': 'bg-green-500' };
        
        async function loadUserCalendars() {
            const calendarsCollectionPath = `artifacts/${firebaseConfig.appId}/users/${currentUserId}/calendars`;
            const q = collection(db, calendarsCollectionPath);
            const querySnapshot = await getDocs(q);
            const calendarList = querySnapshot.docs.map(doc => doc.id);

            calendarSelector.innerHTML = '';
            if (calendarList.length === 0) {
                 calendarSelector.innerHTML = '<option>Crea un calendario</option>';
                 deleteCalendarBtn.disabled = true;
                 mainCalendarArea.style.display = 'none';
                 footerNotes.style.display = 'block';
                 activeCalendarName = null;
                 if(calendarUnsubscribe) calendarUnsubscribe();
            } else {
                deleteCalendarBtn.disabled = false;
                mainCalendarArea.style.display = 'block';
                footerNotes.style.display = 'none';
                let currentActive = localStorage.getItem(`activeCalendar_${currentUserId}`);
                if (!calendarList.includes(currentActive)) {
                    currentActive = calendarList[0];
                }
                activeCalendarName = currentActive;

                calendarList.forEach(name => {
                    const opt = document.createElement('option');
                    opt.value = name;
                    opt.textContent = name;
                    if (name === activeCalendarName) opt.selected = true;
                    calendarSelector.appendChild(opt);
                });
                listenToActiveCalendar();
            }
        }

        function listenToActiveCalendar() {
            if (calendarUnsubscribe) calendarUnsubscribe();
            if (!currentUserId || !activeCalendarName) {
                calendarData = {};
                renderCalendar();
                return;
            }
            
            const calendarDocRef = doc(db, `artifacts/${firebaseConfig.appId}/users/${currentUserId}/calendars/${activeCalendarName}`);
            calendarUnsubscribe = onSnapshot(calendarDocRef, (doc) => {
                calendarData = doc.exists() ? doc.data().data || {} : {};
                renderCalendar();
            });
        }

        function renderCalendar() {
            calendarGrid.innerHTML = '';
            header.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            currentMonthYearEl.textContent = `${currentDate.toLocaleString('es-ES', { month: 'long' })} ${year}`;
            
            ['L', 'M', 'X', 'J', 'V', 'S', 'D'].forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.textContent = day;
                dayEl.className = 'text-center font-bold p-2 border-b border-gray-700';
                header.appendChild(dayEl);
            });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const dayOffset = (firstDay === 0) ? 6 : firstDay - 1;

            for (let i = 0; i < dayOffset; i++) {
                calendarGrid.appendChild(document.createElement('div'));
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'day-cell border p-2 h-24 text-center border-gray-700 relative';
                
                const dayNumber = document.createElement('span');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                dayEl.appendChild(dayNumber);

                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                if (calendarData[dateStr] && calendarData[dateStr].shift) {
                    const shift = calendarData[dateStr].shift;
                    dayEl.classList.add(shiftTypes[shift] || 'bg-gray-700');
                    const shiftIndicator = document.createElement('div');
                    shiftIndicator.className = 'shift-indicator absolute bottom-2 left-2 right-2 text-white text-xs';
                    shiftIndicator.textContent = shift;
                    dayEl.appendChild(shiftIndicator);
                }

                dayEl.addEventListener('click', async () => {
                    if (selectedShift) {
                        const currentData = calendarData[dateStr] || {};
                        if (selectedShift === 'erase') {
                             delete currentData.shift;
                        } else {
                           currentData.shift = selectedShift;
                        }
                        if (Object.keys(currentData).length === 0) {
                            delete calendarData[dateStr];
                        } else {
                           calendarData[dateStr] = currentData;
                        }
                        await setDoc(doc(db, `artifacts/${firebaseConfig.appId}/users/${currentUserId}/calendars/${activeCalendarName}`), { data: calendarData });
                    }
                });
                calendarGrid.appendChild(dayEl);
            }
        }

        function createShiftButtons() {
            shiftSelector.innerHTML = '';
            Object.keys(shiftTypes).forEach(key => {
                const btn = document.createElement('button');
                btn.textContent = key;
                btn.className = `p-2 rounded ${shiftTypes[key]}`;
                btn.onclick = () => { selectedShift = key; };
                shiftSelector.appendChild(btn);
            });
            const eraseBtn = document.createElement('button');
            eraseBtn.textContent = 'Borrar';
            eraseBtn.className = 'p-2 rounded bg-red-600';
            eraseBtn.onclick = () => { selectedShift = 'erase'; };
            shiftSelector.appendChild(eraseBtn);
        }

        toggleEditBtn.addEventListener('click', () => {
            shiftSelector.classList.toggle('hidden');
        });

        document.getElementById('prevMonth').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });
        document.getElementById('nextMonth').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });

        addCalendarBtn.addEventListener('click', async () => {
            const name = newCalendarNameInput.value.trim();
            if(!name) { alert("Introduce un nombre."); return; }
            await setDoc(doc(db, `artifacts/${firebaseConfig.appId}/users/${currentUserId}/calendars/${name}`), { data: {} });
            newCalendarNameInput.value = '';
            localStorage.setItem(`activeCalendar_${currentUserId}`, name);
            loadUserCalendars();
        });
        
        deleteCalendarBtn.addEventListener('click', async () => {
            const name = calendarSelector.value;
            if(!name) { alert("No hay calendario seleccionado."); return; }
            if(confirm(`¿Seguro que quieres eliminar "${name}"?`)) {
                await deleteDoc(doc(db, `artifacts/${firebaseConfig.appId}/users/${currentUserId}/calendars/${name}`));
                localStorage.removeItem(`activeCalendar_${currentUserId}`);
                loadUserCalendars();
            }
        });

        calendarSelector.addEventListener('change', () => {
            activeCalendarName = calendarSelector.value;
            localStorage.setItem(`activeCalendar_${currentUserId}`, activeCalendarName);
            listenToActiveCalendar();
        });
        
        createShiftButtons();
        loadUserCalendars();
    }
</script>
</body>
</html>
